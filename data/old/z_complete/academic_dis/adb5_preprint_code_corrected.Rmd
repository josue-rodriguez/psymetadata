---
title: "Academic Dishonesty and Personality: Preprint Analyses"
author: "Constantin Yves Plessen"
date: "4/8/2019"
output:
  html_document:
    keep_md: true
    code_folding: show
    theme: cerulean
    highlight: pygment
    toc: yes
    toc_float: yes
    toc_depth: 3
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      collapse = FALSE,
                      cache = T,
                      comment = "",
                      strip.white = TRUE,
                      warning = FALSE, #we exclude warnings to improve readability
                      messages = FALSE,
                      out.width = "100%",
                      fig.align = "center")
```


# Overview & Setup

This is an R Markdown document, containing all analyses for the analysis plan for **Associations between academic dishonesty and personality: A pre-registered meta-analysis**.

If you are not familiar with this type of document, you can find a short introduction and manual [here](https://rmarkdown.rstudio.com/lesson-1.html).

We expect to meta-analytically synthesize more than 30 studies, containing associations between (1) self reported academic dishonesty, i.e. plagiarism, cheating, or prohibited help with (2) personality traits operationalized either with the BIG 5, HEXACO, or dark triad.

Therefore, we will expect more than 30 studies, containing multiple correlation coefficients each (5x Big Five traits and at least one academic dishonesty measurment).

A three-level meta-analysis will be calculated for each association with the REML method. Data will be visualized with forest, Baujat and contour enhanced funnel plots.

We will conduct moderator analysis for both categorical moderators (measurement tool for AD, measurement tool for personality, time period for which academic dishonest behavior was assessed) and metric moderators (age, study quality, % female).

Publication bias will be assessed with Eggers regression test, *p*-uniform, p-curve, as well as PET/PEESE analysis.

We will check the robustness of our results with the leave-one-out sensitivity analysis.

## Libraries

The following libraries are needed for general data wrangling, data visualization, and research synthesis.

```{r message = FALSE}
# general data manipulation and setup
library(tidyverse)      # for data wrangling and visualization
library(readxl)         # to easily read excel files
library(magrittr)       # pipe operator
library(broman)         # better rounding of values

# tables and descriptive stats
library(officer)        # exporting word files
library(qwraps2)        # Wrapper function for descriptive tables
library(flextable)      # easily create tables
library(broom)          # tidy outputs
library(summarytools)   # to create descriptive statistics
library(kableExtra)     # for tables

# visualisation
library(plotly)
library(gridExtra)      # to easily combine mulitple plots
library(grid)           # to easily combine mulitple plots
library(viridis)        # color palette
library(wesanderson)    # color palette
library(nord)           # color palette
library(hrbrthemes)     # color palette
library(corrplot)       # correlogram
library(PerformanceAnalytics) # chart of correlation matrix

# research synthesis
library(meta)
library(metafor)        # for 2- and 3-level meta-analysis
library(metaforest)     # for random forest meta-analysis
library(metaviz)        # for advanced data visualization

# p-curve & p-uniform
library(dmetar)         # for p-curve
library(puniform)       # to conduct p-uniform analyis
```

## Loading Data Set

This is the raw data file, all studies were coded once. In the final manuscript, all studies will be coded at least twice by independent coders.

```{r}
data_raw <- read_excel("data/adb5_preprint_data.xlsx", skip = 1, na = "NA")
```

## Helper Functions

This code for PET-PEESE analysis can be found [here](https://github.com/nicebread/meta-showdown/blob/master/MA-methods/3-PET-PEESE.R).

```{r}
tidyRMA <- function(RMA) {
  res <- data.frame(
    term = if(length(RMA$b)==1) {"b0"} else {c("b0", "b1")},
    estimate = as.vector(RMA$b),
    std.error = RMA$se,
    statistic = RMA$zval,
    p.value = RMA$pval,
    conf.low = RMA$ci.lb,
    conf.high = RMA$ci.ub
  )
  rownames(res) <- NULL
  return(res)
}

tidyLM <- function(...) {
  res <- tidy(..., conf.int=TRUE)
  res$term[res$term == "(Intercept)"] <- "b0"
  res$term[res$term == "sqrt(v)"] <- "b1"
  res$term[res$term == "v"] <- "b1"
  return(res)
}


# returns a result data frame either in wide or long format
returnRes <- function(res, long=TRUE, reduce=TRUE) {
  if (is.null(res)) return(NULL)
  
  # convert all factor columns to characters
  res %>% mutate_if(is.factor, as.character) -> res	
  
  if (long==FALSE) {
    # return wide format
    return(res)
  } else {
    # transform to long format
    longRes <- melt(res, id.vars=c("method", "term"))
    if (reduce==TRUE & nrow(res) > 1) {longRes <- longRes %>% filter(!is.na(value)) %>% arrange(method, term, variable)}
    return(longRes)
  }
}

# simple wrapper: formats a number in f.2 format
f2 <- function(x, digits=2, prepoint=0, skipZero=FALSE) {
  
  if (skipZero == TRUE) {zero <- "."} else {zero <- "0."}
  
  if (length(dim(x)) == 2) {
    apply(x, 2, function(x2) {gsub("0.", zero, sprintf(paste("%",prepoint,".",digits,"f",sep=""), x2) , fixed=TRUE)})
  } else {
    gsub("0.", zero, sprintf(paste("%",prepoint,".",digits,"f",sep=""), x) , fixed=TRUE)
  }
}

#' @param long Should the results be returned in long format?
#' @param PP.test "one-sided" or "two-sided" (Stanley's default = one-sided)

# estimator_type: 1 = WAAP; 2 = WLS; 3 = PET; 4 = PEESE

PETPEESE.est <- function(d, v, PP.test = "one-sided", runRMA=FALSE, long=TRUE) {
  
  PP.test <- match.arg(PP.test, PP.test)
  
  PET.lm <- lm(d~sqrt(v), weights=1/v)
  PEESE.lm <- lm(d~v, weights=1/v)
  
  res <- rbind(
    data.frame(method="PET.lm", tidyLM(PET.lm)),
    data.frame(method="PEESE.lm", tidyLM(PEESE.lm))
  )  
  
  # conditional PET/PEESE estimator	
  lm.p.value  <- res %>% filter(method == "PET.lm", term == "b0") %>% .[["p.value"]]
  lm.est  <- res %>% filter(method == "PET.lm", term == "b0") %>% .[["estimate"]]
  
  
  # "For the purpose of deciding which meta-regression accommodation for selective reporting bias to employ, we recommend testing H0:b0 < 0 at the 10% significance level."
  # From: Stanley, T. D. (2016). Limitations of PET-PEESE and other meta-analysis methods. Abgerufen von https://www.hendrix.edu/uploadedFiles/Departments_and_Programs/Business_and_Economics/AMAES/Limitations%20of%20PET-PEESE.pdf
  
  
  if (PP.test == "one-sided") {
    p.crit <- .10
  } else if (PP.test == "two-sided") {
    p.crit <- .05
  }
  
  # the condition always uses a directional hypothesis (a reversed slope should not happen), but different critical levels (.05 vs .10)
  usePEESE.lm <- ifelse(lm.p.value < p.crit & lm.est > 0, TRUE, FALSE)
  
  res <- rbind(res,
               data.frame(method="PETPEESE.lm", if (usePEESE.lm == TRUE) {tidyLM(PEESE.lm)} else {tidyLM(PET.lm)})
  )
  
  
  if (runRMA == TRUE) {
    PET.rma <- tryCatch(
      rma(yi = d, vi = v, mods=sqrt(v), method="REML", control = list(stepadj = .5, maxiter=500)),
      error = function(e) rma(yi = d, vi = v, mods=sqrt(v), method="DL")
    )
    
    PEESE.rma <- tryCatch(
      rma(yi = d, vi = v, mods=v, method="REML", control = list(stepadj = .5, maxiter=500)),
      error = function(e) rma(yi = d, vi = v, mods=v, method="DL")
    )  
    
    res <- rbind(
      res,
      data.frame(method="PET.rma", tidyRMA(PET.rma)),
      data.frame(method="PEESE.rma", tidyRMA(PEESE.rma))
    )
    
    rma.p.value <- res %>% filter(method == "PET.rma", term == "b0") %>% .[["p.value"]]	
    rma.est <- res %>% filter(method == "PET.rma", term == "b0") %>% .[["estimate"]]
    usePEESE.rma <- ifelse(rma.p.value < p.crit & rma.est > 0, TRUE, FALSE)
    res <- rbind(res,
                 data.frame(method="PETPEESE.rma", if (usePEESE.rma == TRUE) {tidyRMA(PEESE.rma)} else {tidyRMA(PET.rma)})
    )
  }
  
  
  res <- plyr::rbind.fill(res, data.frame(method="PETPEESE.lm", term="estimator", type=ifelse(usePEESE.lm == TRUE, 4, 3)))
  
  if (runRMA == TRUE) {
    res <- plyr::rbind.fill(res, data.frame(method="PETPEESE.rma", term="estimator", type=ifelse(usePEESE.rma == TRUE, 4, 3)))	
  } else {
    res$method <- gsub(".lm", "", res$method, fixed=TRUE)
  }
  
  returnRes(res, long)
}
```

# Data Cleaning

## Exclusions

```{r}
data_raw <- data_raw %>% 
  filter(study_id != "28.1")
```

## Overview

```{r}
glimpse(data_raw)
```

## New Variables

### Study and effect ID

We need two variables for the multilevel model indicating the effect sizes nested in the studies. Thus, study_id is seperated into two new columns: ```study_id``` and ```es_id```

```{r}
data_raw <- data_raw %>% 
  separate(col = study_id, into = c("study_id", "es_id"), 
           sep = "\\.")
```

<br>

### Year variable

As there is no column for the year the study was conducted, the information is pulled from the ```short_ref``` variable.
```{r}
data_raw <- data_raw %>% 
  mutate(year = parse_number(short_ref))
```
```{r}
data_raw %>% 
  filter(is.na(year)) %>% 
  select(short_ref, year)
```

For some reason the function ```parse_number()``` couldn´t find the year for 4 rows, those are added manually:

```{r}
data_raw <- data_raw %>% 
  mutate(year = replace(year, short_ref == "Barbaranelli et al., 2018", 2018)) %>% 
  mutate(year = replace(year, short_ref == "Ramirez-Correa, 2017", 2017)) %>% 
  mutate(year = replace(year, short_ref == "Salgado et al., 2015", 2015))
```

<br>

## Converting variables

As ```read_excel()``` guesses column type based on Excel cell types, we need to convert variables manually to either numerics or factors with ```as.numeric()``` or ```as.factor()```.

```{r}
data <- data_raw %>% 
  mutate_at(vars(study_id, # convert to numeric
                 es_id,
                 year,
                 perc_female, 
                 n_female, 
                 n_male,
                 age_mean,
                 age_sd,
                 alpha_open:alpha_ad,
                 r_open:r_dark_4,
                 qual_rep:qual_tool_personality,
                 coding_difficulty), 
            ~ as.numeric(.)) %>% 
  mutate_at(vars(coded_by,    # convert to factors
                 sample_country,
                 language,
                 mod_ad_inventory,
                 mod_ad_period,
                 mod_personality_inventory,
                 mod_dark_inventory), 
            ~ as.factor(.)) 
```

<br>

### New Subgroups

#### Continent 

<br>

**New levels:**  

* North America  
* Europe  
* Asia  
* Other  

<br>

Overview over sample countries:

```{r}
table(data$sample_country)
table(is.na(data$sample_country))
```
<br>

Renaming of countries:

```{r}
data$sample_country <- recode(data$sample_country,
                              australia = "Australia", 
                              chile = "Chile", 
                              German = "Germany", 
                              Indian = "India", 
                              iran = "Iran",
                              romania = "Romania",
                              "south africa" = "South Africa",
                              "western europe" = "Western Europe")

table(data$sample_country)
```

```{r}
europe <- c("Germany", "France", "Italy", "Netherlands", "Poland", "Portugal", 
            "Romania", "Spain", "UK", "Western Europe")     

north_america <- c("USA", "Canada")

asia <- c("China", "India", "Indonesia", "Malaysia", "Pakistan")

other <- c("Australia", "Chile", "Iran", "Israel", "USA/Israel", "South Africa")

data <- data %>%
  mutate(continent = ifelse(sample_country %in% europe, "europe",
                            ifelse(sample_country %in% asia, "asia",
                                   ifelse(sample_country %in% north_america, "north_america", "other"))))

data$continent <- as.factor(data$continent)
```

<br>

#### Period Academic Dishonesty

This moderator cannot be used at at this time, as there a too few observations present. This needs to be coded again for the manuscript.

```{r}
table(data$mod_ad_period)

table(is.na(data$mod_ad_period))
```

<br>

#### Academic dishonesty inventory

```{r}
table(data$mod_ad_inventory)
```

Group 1: Behavioral
Group 2: Self-constructed
Group 3: Validated

```{r}
group_1 <- c("behavioral", "Turn-It-In", "Turn-it in")
group_2 <- ("self-constructed") 

data <- data %>%
  mutate(ad_inventory = mod_ad_inventory) %>%  # saving inventories in new variable
  mutate(mod_ad_inventory = ifelse(ad_inventory %in% group_1, "1", # overwriting moderator variable with new groups
                                   ifelse(ad_inventory %in% group_2, "2", "3")))

data$mod_ad_inventory <- as.factor(data$mod_ad_inventory)

table(data$mod_ad_inventory)
```

<br>

#### Personality inventory

```{r}
table(data$mod_personality_inventory)
```

As there are two many inventories for subgroup analysis, we group the inventories into 4 groups that measure:

1. The Big 5  
2. Short version of the Big 5  
3. The Big 6  
4. Other personality measures (Eysenck, Hogen, Maudsley, etc.)  

```{r}
# Group 1 - Big 5:

group_1 <- c("BFI", # Big Five Inventory
             "IPIP", # 50-item Sample Questionnaire from the International Personality Item Pool
             "Goldberg", #  50 big five personality measurement items adopted and adapted from Goldberg (1990)
             "NEO-PI", # NEO Personality Inventory 
             "NEO-PI-R", #  The NEO PI-R includes 240 items and three validity items. 
             "NEO-PI-R + IP/5F", # NEO PI-R (Costa & McCrae, 1992, 2008) and IP/5F (Salgado, 1996, 1998a).
             "FFM" # self-constructed Big 5 measure 
)

# Group 2 - Big 5 Short Scales: 

group_2 <- c("BFI-SV", # 4 item subscale Neuroticism
             "BFI10", # Short (S) version of the Big Five Inventory
             "TIPI", # Ten Item Personality Invenory: 10 items scale developed by Rammstedt and John (2007)
             "NEO-FFI" # Short version of the NEO-PI
)

# Group 3 - HEXACO: 

group_3 <- c("MPT-BS", # The MPT-BS (NOA, 2009)
             "HEXACO-PI", 
             "HEXACO-PI-R", 
             "HEXACO" # HEXACO Personality Assessment Inventory (Ashton & Lee, 2009)
)

# Group 4 - Other: 

group_4 <- c("ECS", # Explicit Conscientiousness Scale
             "IAT", # Implicit conscientiousness
             "BTI", # Conscientiousness scale of the Basic Traits Inventory
             "OPQ32r", # 32-item Occupational Personality Questionnaire
             "EPQ-R", # Eysenck Personality Questionnaire
             "HPI", # The Hogan Personality Inventory
             "TRAQSP", # Trait Rating Adjectives Questionnaire: Self & Partner Report (Botwin et al., 1997)
             "MPI" # Hindi adaption of Maudsley´s Personality Inventory by Jalota and Kapoor (1975)
)

data <- data %>%
  # saving inventories in new variable
  mutate(personality_inventory = mod_personality_inventory) %>%  
  
  # overwriting moderator variable with new groups
  mutate(mod_personality_inventory = ifelse(personality_inventory %in% group_1, "Big 5", 
                                            ifelse(personality_inventory %in% group_2, "Big 5 Short", 
                                                   ifelse(personality_inventory %in% group_3, "Big 6",
                                                          ifelse(personality_inventory %in% group_4, "Other", 
                                                                 "NA")))))

data$mod_personality_inventory <- as.factor(data$mod_personality_inventory)

table(data$mod_personality_inventory)
```

<br>

#### Dark inventory

```{r}
table(data$mod_dark_inventory)
```


```{r}
# Group 1: Individual Facets of Dark Triad
group_1 <- c("LSRP", #  Levenson's Self-Report Psychopathy scale by Levenson, Kiehl, and Fitzpatrick’s (1995)
             "MACH-IV", # 20-item Mach-IV (Christie & Geis, 1970)
             "MPS", # Machiavellianism Personality Scale 
             "MS", # Machiavellianism scale 
             "NPI", # Narcissistic Personality Inventory (NPI; Raskin & Hall, 1979)
             "NPI, Mach-IV, SRP-III",
             "PPI", # Psychopathic Personality Inventory Lilienfeld & Andrews, (1996)
             "SRP-III", # Self-Report Psychopathy Scale (Paulhus et al., in press)
             "TRIPM" # Triarchical measure of psychopathy adapted to Polish conditions 
)

# Group 2: Individual Facets of Dark Triad - short versions
group_2 <- ("PPI-SF" #  Psychopathic Personality Inventory Short Form ( Lilienfeld & Widows, 2005) 
)

# Group 3: Dark Triad
group_3 <- ("SD3" # Short Dark Triad (SD3; Jones & Paulhus, 2014).
)

data <- data %>%
  # saving inventories in new variable
  mutate(dark_inventory = mod_dark_inventory) %>% 
  
  # overwriting moderator variable with new groups
  mutate(mod_dark_inventory = ifelse(dark_inventory %in% group_1, "1",
                                     ifelse(dark_inventory %in% group_2, "2",
                                            ifelse(dark_inventory %in% group_3, "3", 
                                                   "NA"))))

data$mod_dark_inventory <- as.factor(data$mod_dark_inventory)

table(data$mod_dark_inventory)
```

# Exploratory Data Analysis

## Final Data Set

```{r}
glimpse(data)
```

## Summary Statistics

<br>

```{r}
summary(data)
```

```{r}
sum(data$sample_size)

sd(data$age_mean, na.rm = T)

length(unique(as.character(data$sample_country)))

table(data$continent)
```


```{r}
options(qwraps2_markup = "markdown")

data %>%
  dplyr::select(year, 
                sample_size, 
                perc_female, 
                age_mean, 
                sample_country, 
                language, 
                mod_ad_period, 
                mod_ad_inventory, 
                mod_personality_inventory, 
                mod_dark_inventory,
                mod_study_quality) %>%
  summary_table(.)
```

```{r}
# data %>%
#   arrange(study_id) %>% # arrange by study id
#   kable() %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
#   scroll_box(width = "100%")
```

## Data Visualization

### Personality Traits

Histograms for all correlations between academic dishonesty and Big 5 Personality Traits + Honesty-Humility

```{r}
p <- data %>% 
  ggplot() +
  labs(x = "r", y = "Count") +
  theme(axis.title = element_text(size = 15), 
        plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 15)) + 
  scale_y_continuous(limits=c(0,6), 
                     breaks = seq(0, 6, by = 2),
                     labels = c("0","2", "4", "6")) +
  scale_x_continuous(limits=c(-1,1), 
                     breaks = seq(-1,1, by = .25),
                     labels = c("-1","", "-.5", "", "0", "", ".5", "", "1")) +
  theme_minimal()

p1 <- p + 
  geom_histogram(aes(r_open), 
                 fill = "#1380A1", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Openness") +
  labs(x = "", y = "Count") 

p2 <- p + 
  geom_histogram(aes(r_consci), 
                 fill = "#FAAB18", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") + 
  labs(subtitle = "Conscientousness") +
  labs(x = "r", y = "count") 

p3 <- p + 
  geom_histogram(aes(r_extra), 
                 fill = "#990000", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Extraversion") +
  labs(x = "r", y = "Count") 

p4 <- p + 
  geom_histogram(aes(r_agree), 
                 fill = "#663366", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Agreeableness") +
  labs(x = "", y = "") 

p5 <- p + 
  geom_histogram(aes(r_neuro), 
                 fill = "#666666", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Neuroticism") +
  labs(x = "r", y = "") 

p6 <- p + 
  geom_histogram(aes(r_hh), 
                 fill = "#666666", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Honesty-Humility") +
  labs(x = "r", y = "") 

grid.arrange(p1, p4, p2, p3, p5, p6,
             nrow = 2, 
             respect = T,
             top = textGrob("Personality Traits: Distribution of Correlations",
                            gp = gpar(fontsize = 15, fontface = "bold")))
```

### Dark Triad

```{r}
dt <- data %>% 
  ggplot() +
  labs(x = "r", y = "Count") +
  theme(axis.title = element_text(size = 15), 
        plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 15)) + 
  scale_y_continuous(limits=c(0,6), 
                     breaks = seq(0, 6, by = 2),
                     labels = c("0","2", "4", "6")) +
  scale_x_continuous(limits=c(-1,1), 
                     breaks = seq(-1,1, by = .25),
                     labels = c("-1","", "-.5", "", "0", "", ".5", "", "1")) +
  theme_minimal()

dt1 <- dt + 
  geom_histogram(aes(r_mach), 
                 fill = "#1380A1", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Machiavellism") +
  labs(x = "r", y = "Count") 

dt2 <- dt + 
  geom_histogram(aes(r_psycho), 
                 fill = "#FAAB18", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") + 
  labs(subtitle = "Psychopathy") +
  labs(x = "r", y = "") 

dt3 <- dt + 
  geom_histogram(aes(r_narc), 
                 fill = "#990000", 
                 alpha = 1, 
                 bins = 30, 
                 colour = "white") +
  labs(subtitle = "Narcissism") +
  labs(x = "r", y = "") 


grid.arrange(dt1, dt2, dt3, 
             nrow = 1, 
             respect = T,
             top = textGrob("Dark Triad: Distribution of Correlations",
                            gp = gpar(fontsize = 15, fontface = "bold")))
```

*** 

# 1. Openness

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
open_data <- escalc(measure = "ZCOR", 
                    ri = r_open, 
                    ni = sample_size, 
                    data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>%  # Arrange by publication year for visualization 
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
open_mlm <- rma.mv(yi, 
                   vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   tdist = T, # Knapp-Hartung adjustment for confidence intervals
                   data = open_data,
                   method = "REML")

summary(open_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
open_r <- predict(open_mlm, digits = 3, transf = transf.ztor)

open_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

#### Preregistered Analysis

We preregistered the following calculations for Higgins I^2^ as described [here](http://www.metafor-project.org/doku.php/tips:i2_multilevel_multivariate)

```{r}
confint(open_mlm)

W <- diag(1/open_data$vi)

X <- model.matrix(open_mlm)

P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W

open_mlm_I2_manually <- 100 * sum(open_mlm$sigma2) / (sum(open_mlm$sigma2) + (open_mlm$k-open_mlm$p)/sum(diag(P)))

open_mlm_I2_manually # This value is the Higgins I2 for the three-level model
```

<br>

We also preregistered the following calculation for total variance that can be attributed to between- and within-cluster heterogeneity separately: 
```{r}
open_mlm_var <- 100 * open_mlm$sigma2 / (sum(open_mlm$sigma2) + (open_mlm$k-open_mlm$p)/sum(diag(P)))

open_mlm_var
```


<br>

#### Analysis with ```dmetar``` package

In the meantime, the ```dmetar``` package was released, containing a function to calculate the variance distribution more easily—which we will use for all our analyses:

```{r}
open_mlm_variance <- mlm.variance.distribution(x = open_mlm)
```

Thus it is easy to pull out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
open_mlm_level1 <- round(open_mlm_variance[1, 1], 2)
open_mlm_level1

open_mlm_level2 <- round(open_mlm_variance[2, 1], 2)
open_mlm_level2

open_mlm_level3 <- round(open_mlm_variance[3, 1], 2)
open_mlm_level3

open_mlm_I2 <- sum(open_mlm_level2, open_mlm_level3)
open_mlm_I2
```

`r open_mlm_level1`% of the overall variance can be attributed to level 1, `r open_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r open_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r open_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
open_mlm.l2.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = open_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(open_mlm.l2.removed)

anova(open_mlm, open_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
open_mlm.l3.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = open_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(open_mlm.l3.removed)

open_mlm.l3.removed_anova <- anova(open_mlm, open_mlm.l3.removed)

open_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot in metaviz

Not yet implemented in metaviz!
```{r}
open_data_year <- open_data %>%
  arrange(year)

open_mlm_forest <- viz_forest(open_mlm,
           summary_label = "Summary effect",
           study_labels = open_data_year$short_ref,
           method = "REML",
           xlab = "Correlation Coefficient",
           variant = "rain",
           annotate_CI = TRUE,
           table_headers = "Correlation [95% CI]")

open_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_openness.svg', width = 8, height = 11) 

### set up forest plot
forest(open_mlm, 
       slab = open_data$short_ref,
       addcred=F)
### add column headings to the plot
op <- par(cex= 1, font=2)
text(-2.15, 45, "Author(s) and Year",  pos=4)
text(1.7, 45, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```


### Funnel Plot
```{r}
# Show Egger's regression line:
open_mlm_funnel <- viz_funnel(x = open_mlm, 
                              contours = TRUE,
                              trim_and_fill = F, 
                              egger = TRUE)

open_mlm_funnel
```


## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
open_mod_age <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = open_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ age_mean)
open_mod_age
```

<br>

*F*(1, `r open_mod_age$dfs`) = `r round(open_mod_age$QM, 3)` *p* = `r round(open_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(open_data$vi)
size <- size / max(size)

open_bubble_age <- ggplot(open_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

open_bubble_age
```




*** 
<br>

#### Sex

```{r}
open_mod_sex <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = open_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ perc_female)
open_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(open_data$vi)
size <- size / max(size)

open_bubble_sex <- ggplot(open_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

open_bubble_sex
```

***
<br>

#### Study Quality

```{r}
open_mod_quality <- rma.mv(yi, 
                           vi, 
                           random = list(~ 1 | es_id, # level 2
                                         ~ 1 | study_id), # level 3
                           data = open_data,
                           method = "REML",
                           tdist = TRUE, 
                           mods = ~ mod_study_quality)
open_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(open_data$vi)
size <- size / max(size)

open_bubble_quality <- ggplot(open_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

open_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
open_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", open_mod_age$k, open_mod_age$b[2], open_mod_age$se[2],  open_mod_age$QM, open_mod_age$QMp,
  "% Female", open_mod_sex$k, open_mod_sex$b[2], open_mod_sex$se[2],  open_mod_sex$QM, open_mod_sex$QMp,
  "Study Quality", open_mod_quality$k, open_mod_quality$b[2], open_mod_quality$se[2],  open_mod_quality$QM, open_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

open_table_regression <- open_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

open_table_regression <- add_header_lines(open_table_regression, 
                                          values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

open_table_regression <- theme_booktabs(open_table_regression)
open_table_regression <- italic(open_table_regression, italic = TRUE, part = "header")

open_table_regression 
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
open_data_mod1 <- open_data %>%
  drop_na(mod_ad_inventory)

open_mod_ad <- rma.mv(yi,
                      vi,
                      random = list(~ 1 | es_id, # level 2
                                    ~ 1 | study_id), # level 3
                      data = open_data_mod1,
                      method = "REML",
                      tdist = TRUE,
                      mods = ~ mod_ad_inventory)

open_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
open_forest_ad <- viz_forest(x = open_mod_ad,
                             study_labels =  open_data_mod1$short_ref,
                             method = "REML",
                             summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                             xlab = "Correlation",
                             variant = "rain",
                             text_size = 2, 
                             annotate_CI = T)

open_forest_ad
```

##### Table 

```{r}
open_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      open_mod_ad$b[1], open_mod_ad$se[1], open_mod_ad$ci.lb[1], open_mod_ad$ci.ub[1], open_mod_ad$zval[1], open_mod_ad$pval[1], 
  "Self-Constructed",   open_mod_ad$b[2], open_mod_ad$se[2], open_mod_ad$ci.lb[2], open_mod_ad$ci.ub[2], open_mod_ad$zval[2], open_mod_ad$pval[2], 
  "Validated",       open_mod_ad$b[3], open_mod_ad$se[3], open_mod_ad$ci.lb[3], open_mod_ad$ci.ub[3], open_mod_ad$zval[3], open_mod_ad$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

open_table_ad <- open_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

open_table_ad <- add_header_lines(open_table_ad, 
                                  values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
open_table_ad <- theme_booktabs(open_table_ad)

open_table_ad <- italic(open_table_ad, italic = TRUE, part = "header")

open_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# open_data_mod2 <- open_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = open_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  open_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Personality Inventory

```{r}
table(open_data$mod_personality_inventory)
```


```{r}
# Dropping NAs
open_data_mod3 <- open_data %>%
  filter(mod_personality_inventory != "NA")

# calculating subgroup analyis
open_mod_pers <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = open_data_mod3,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ mod_personality_inventory)

open_mod_pers
```

<br>

##### Subgroup Forest Plot

```{r}
open_forest_personality <- viz_forest(x = open_mod_pers,
                                      study_labels =  open_data_mod3$short_ref,
                                      method = "REML",
                                      summary_label = c("Big 5", "Big 5 Short", "Big 6", "Other"), 
                                      xlab = "Correlation",
                                      variant = "rain",
                                      text_size = 2, 
                                      annotate_CI = T)

open_forest_personality
```

##### Table

```{r}
open_table_personality <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Big 5 ",      open_mod_pers$b[1], open_mod_pers$se[1], open_mod_pers$ci.lb[1], open_mod_pers$ci.ub[1], open_mod_pers$zval[1], open_mod_pers$pval[1], 
  "Big Short",   open_mod_pers$b[2], open_mod_pers$se[2], open_mod_pers$ci.lb[2], open_mod_pers$ci.ub[2], open_mod_pers$zval[2], open_mod_pers$pval[2], 
  "Big 6",       open_mod_pers$b[3], open_mod_pers$se[3], open_mod_pers$ci.lb[3], open_mod_pers$ci.ub[3], open_mod_pers$zval[3], open_mod_pers$pval[3],
  "Other",       open_mod_pers$b[4], open_mod_pers$se[4], open_mod_pers$ci.lb[4], open_mod_pers$ci.ub[4], open_mod_pers$zval[4], open_mod_pers$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

open_table_personality <- open_table_personality %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

open_table_personality <- add_header_lines(open_table_personality, 
                                           values = c("Results of subgroup analysis for personality inventory.", "Table 4"))
open_table_personality <- theme_booktabs(open_table_personality)

open_table_personality <- italic(open_table_personality, italic = TRUE, part = "header")

open_table_personality
```

#### Continent

```{r}
# Dropping NAs
open_data_mod4 <- open_data %>%
  drop_na(continent)

open_mod_cont <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = open_data_mod4,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ continent)

open_mod_cont
```

```{r}
open_forest_continent <- viz_forest(x = open_mod_cont,
                                    study_labels =  open_data_mod4$short_ref,
                                    method = "REML",
                                    summary_label = c("Asia", "Europe", "North America", "Other"), 
                                    xlab = "Correlation",
                                    variant = "rain",
                                    text_size = 2, 
                                    annotate_CI = T)
```

##### Table

```{r}
open_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      open_mod_cont$b[1], open_mod_cont$se[1], open_mod_cont$ci.lb[1], open_mod_cont$ci.ub[1], open_mod_cont$zval[1], open_mod_cont$pval[1], 
  "Europe",   open_mod_cont$b[2], open_mod_cont$se[2], open_mod_cont$ci.lb[2], open_mod_cont$ci.ub[2], open_mod_cont$zval[2], open_mod_cont$pval[2], 
  "North America",       open_mod_cont$b[3], open_mod_cont$se[3], open_mod_cont$ci.lb[3], open_mod_cont$ci.ub[3], open_mod_cont$zval[3], open_mod_cont$pval[3],
  "Other",       open_mod_cont$b[4], open_mod_cont$se[4], open_mod_cont$ci.lb[4], open_mod_cont$ci.ub[4], open_mod_cont$zval[4], open_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

open_table_continent <- open_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

open_table_continent <- add_header_lines(open_table_continent, 
                                         values = c("Results of subgroup analysis for continent.", "Table 5"))
open_table_continent <- theme_booktabs(open_table_continent)

open_table_continent <- italic(open_table_continent, italic = TRUE, part = "header")

open_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = open_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_personality_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
open_data_center <- open_data %>% 
  mutate(alpha_open_mean = scale(alpha_open, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
open_alpha <- rma(yi, vi, 
                  random = list(~ 1 | es_id, # level 2
                                ~ 1 | study_id), # level 3
                  data = open_data_center, 
                  digits = 3,
                  mods = ~ 
                    alpha_open_mean + alpha_ad_mean)

open_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
open_alpha$k
open_alpha$b[1]
open_alpha$ci.lb[1]
open_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
open_data_rem <- open_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
open_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = open_data_rem, sm = "ZCOR",
                         method.tau = "REML")

open_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
open_data_rem <- escalc(measure = "ZCOR", 
                        ri = r, 
                        ni = sample_size, 
                        data = open_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
open_rem <- rma(yi, vi, 
                data = open_data_rem, 
                slab = open_data_rem$short_ref) 
open_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(open_rem) 
```

*** 
<br>

### Forest Plot

```{r}
open_rem_forest <- viz_forest(open_rem, 
                              summary_label = "Summary effect", 
                              study_labels = open_data_rem$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")
open_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
open_egger <- regtest(open_rem)
open_egger
```

*** 

<br>

### *p*-uniform

```{r}
open_puniform <- puniform(ri = open_data_rem$r, 
                          ni = open_data_rem$N, 
                          alpha = .05,
                          side = "right", 
                          method = "P", 
                          plot = TRUE)

open_puniform
```

Estimate: *r* = `r round(open_puniform$est, 3)` 95% CI [`r round(open_puniform$ci.lb, 3)`, `r round(open_puniform$ci.ub, 3)`]
*k* = `r open_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
open_puniform_star <- puni_star(ri = open_data_rem$r, 
                                ni = open_data_rem$N, 
                                alpha = .05,
                                side = "right", 
                                method = "ML")
open_puniform_star
```
Estimate: *r* = `r round(open_puniform_star$est, 3)` 95% CI [`r round(open_puniform_star$ci.lb, 3)`, `r round(open_puniform_star$ci.ub, 3)`]

*k* = `r open_puniform_star$k`

*** 
<br>

###  *p*-curve

<br>

The initial idea for the analysis plan was to copy-paste 
below output to the [*p*-curve app](http://www.p-curve.com/app4/) to calculate the *p*-curve.

```{r}
open_data_rem_p_curve <- open_data_rem %>% 
  mutate(p_curve = paste0("r","(", sample_size - 1, ")", "=", round(r, 3) ))

p_curve_open <- noquote(open_data_rem_p_curve$p_curve)

noquote(paste0(p_curve_open, sep = ", "))
```

<br>

As the ```dmetar``` package contains a function to conduct the *p*-curve, all analyses will be conducted as follows:

```{r error=TRUE}

open_p_curve <- pcurve(open_rem_meta, 
                       effect.estimation = TRUE, 
                       N = open_data_rem$sample_size, 
                       dmin = 0, 
                       dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
open_p_curve_est = open_p_curve$dEstimate/sqrt(open_p_curve$dEstimate^2 + 4)

open_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
open_petpeese <- PETPEESE.est(open_data_rem$yi, open_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

open_petpeese
```

*** 
<br>

## Sensitivity Analysis

### Leave-one-out 
```{r}
open_rem_sens <- leave1out(open_rem, digits = 2)
round(min(open_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(open_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
open_inf <- influence(open_rem)

plot(open_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
open_baujat <- baujat(open_rem, symbol = "slab")
open_baujat
```

<br>

*** 

# 2. Conscientousness

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
consci_data <- escalc(measure = "ZCOR", 
                      ri = r_consci, 
                      ni = sample_size, 
                      data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>%  # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
consci_mlm <- rma.mv(yi, 
                     vi, 
                     random = list(~ 1 | es_id, # level 2
                                   ~ 1 | study_id), # level 3
                     tdist = T, # Knapp-Hartung adjustment for confidence intervals
                     data = consci_data,
                     method = "REML")

summary(consci_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
consci_r <- predict(consci_mlm, digits = 3, transf = transf.ztor)

consci_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
consci_mlm_variance <- mlm.variance.distribution(x = consci_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
consci_mlm_level1 <- round(consci_mlm_variance[1, 1], 2)
consci_mlm_level1

consci_mlm_level2 <- round(consci_mlm_variance[2, 1], 2)
consci_mlm_level2

consci_mlm_level3 <- round(consci_mlm_variance[3, 1], 2)
consci_mlm_level3

consci_mlm_I2 <- sum(consci_mlm_level2, consci_mlm_level3)
consci_mlm_I2
```

`r consci_mlm_level1`% of the overall variance can be attributed to level 1, `r consci_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r consci_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r consci_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
consci_mlm.l2.removed <- rma.mv(yi, 
                                vi, 
                                random = list(~ 1 | es_id, # level 2
                                              ~ 1 | study_id), # level 3
                                tdist = T, # Knapp-Hartung adjustment for confidence intervals
                                data = consci_data,
                                method = "REML",
                                sigma2 = c(0, NA))

summary(consci_mlm.l2.removed)

anova(consci_mlm, consci_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
consci_mlm.l3.removed <- rma.mv(yi, 
                                vi, 
                                random = list(~ 1 | es_id, # level 2
                                              ~ 1 | study_id), # level 3
                                tdist = T, # Knapp-Hartung adjustment for confidence intervals
                                data = consci_data,
                                method = "REML",
                                sigma2 = c(0, NA))

summary(consci_mlm.l3.removed)

consci_mlm.l3.removed_anova <- anova(consci_mlm, consci_mlm.l3.removed)

consci_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

### Forest Plot
```{r}
consci_data_year <- consci_data %>% 
  arrange(year)

consci_mlm_forest <- viz_forest(consci_mlm, 
                                summary_label = "Summary effect", 
                                study_labels = consci_data_year$short_ref,
                                method = "REML",
                                xlab = "Correlation Coefficient", 
                                variant = "rain",
                                annotate_CI = TRUE, 
                                table_headers = "Correlation [95% CI]")

consci_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_consci.svg', width = 9.5, height = 13) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
consci_mlm_forest_mf <- forest(consci_mlm, 
                               slab = consci_data$short_ref,
                               addcred=F)

consci_mlm_forest_mf

### add column headings to the plot
op <- par(cex= .9, font=2)
text(-2.6, 63, "Author(s) and Year",  pos=4)
text(1.9, 63, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
consci_mlm_funnel <- viz_funnel(x = consci_mlm, 
                                contours = TRUE,
                                trim_and_fill = F, 
                                egger = TRUE)

consci_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
consci_mod_age <- rma.mv(yi, 
                         vi, 
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = consci_data,
                         method = "REML",
                         tdist = TRUE, 
                         mods = ~ age_mean)
consci_mod_age
```

<br>

*F*(1, `r consci_mod_age$dfs`) = `r round(consci_mod_age$QM, 3)` *p* = `r round(consci_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(consci_data$vi)
size <- size / max(size)

consci_bubble_age <- ggplot(consci_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

consci_bubble_age
```




*** 
<br>

#### Sex

```{r}
consci_mod_sex <- rma.mv(yi, 
                         vi, 
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = consci_data,
                         method = "REML",
                         tdist = TRUE, 
                         mods = ~ perc_female)
consci_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(consci_data$vi)
size <- size / max(size)

consci_bubble_sex <- ggplot(consci_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

consci_bubble_sex
```

***
<br>

#### Study Quality

```{r}
consci_mod_quality <- rma.mv(yi, 
                             vi, 
                             random = list(~ 1 | es_id, # level 2
                                           ~ 1 | study_id), # level 3
                             data = consci_data,
                             method = "REML",
                             tdist = TRUE, 
                             mods = ~ mod_study_quality)
consci_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(consci_data$vi)
size <- size / max(size)

consci_bubble_quality <- ggplot(consci_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

consci_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
consci_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", consci_mod_age$k, consci_mod_age$b[2], consci_mod_age$se[2],  consci_mod_age$QM, consci_mod_age$QMp,
  "% Female", consci_mod_sex$k, consci_mod_sex$b[2], consci_mod_sex$se[2],  consci_mod_sex$QM, consci_mod_sex$QMp,
  "Study Quality", consci_mod_quality$k, consci_mod_quality$b[2], consci_mod_quality$se[2],  consci_mod_quality$QM, consci_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

consci_table_regression <- consci_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

consci_table_regression <- add_header_lines(consci_table_regression, 
                                            values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

consci_table_regression <- theme_booktabs(consci_table_regression)
consci_table_regression <- italic(consci_table_regression, italic = TRUE, part = "header")

consci_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
consci_data_mod1 <- consci_data %>%
  drop_na(mod_ad_inventory)

consci_mod_ad <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = consci_data_mod1,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ mod_ad_inventory)

consci_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
consci_forest_ad <- viz_forest(x = consci_mod_ad,
                               study_labels =  consci_data_mod1$short_ref,
                               method = "REML",
                               summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                               xlab = "Correlation",
                               variant = "rain",
                               text_size = 2, 
                               annotate_CI = T)

consci_forest_ad
```

##### Table 

```{r}
consci_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      consci_mod_ad$b[1], consci_mod_ad$se[1], consci_mod_ad$ci.lb[1], consci_mod_ad$ci.ub[1], consci_mod_ad$zval[1], consci_mod_ad$pval[1], 
  "Self-Constructed",   consci_mod_ad$b[2], consci_mod_ad$se[2], consci_mod_ad$ci.lb[2], consci_mod_ad$ci.ub[2], consci_mod_ad$zval[2], consci_mod_ad$pval[2], 
  "Validated",       consci_mod_ad$b[3], consci_mod_ad$se[3], consci_mod_ad$ci.lb[3], consci_mod_ad$ci.ub[3], consci_mod_ad$zval[3], consci_mod_ad$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

consci_table_ad <- consci_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

consci_table_ad <- add_header_lines(consci_table_ad, 
                                    values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
consci_table_ad <- theme_booktabs(consci_table_ad)

consci_table_ad <- italic(consci_table_ad, italic = TRUE, part = "header")

consci_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# consci_data_mod2 <- consci_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = consci_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  consci_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Personality Inventory

```{r}
table(consci_data$mod_personality_inventory)
```


```{r}
# Dropping NAs
consci_data_mod3 <- consci_data %>%
  filter(mod_personality_inventory != "NA")

# calculating subgroup analyis
consci_mod_pers <- rma.mv(yi,
                          vi,
                          random = list(~ 1 | es_id, # level 2
                                        ~ 1 | study_id), # level 3
                          data = consci_data_mod3,
                          method = "REML",
                          tdist = TRUE,
                          mods = ~ mod_personality_inventory)

consci_mod_pers
```

<br>

##### Subgroup Forest Plot

```{r}
consci_forest_personality <- viz_forest(x = consci_mod_pers,
                                        study_labels =  consci_data_mod3$short_ref,
                                        method = "REML",
                                        summary_label = c("Big 5", "Big 5 Short", "Big 6", "Other"), 
                                        xlab = "Correlation",
                                        variant = "rain",
                                        text_size = 2, 
                                        annotate_CI = T)

consci_forest_personality
```

##### Table

```{r}
consci_table_personality <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Big 5 ",      consci_mod_pers$b[1], consci_mod_pers$se[1], consci_mod_pers$ci.lb[1], consci_mod_pers$ci.ub[1], consci_mod_pers$zval[1], consci_mod_pers$pval[1], 
  "Big Short",   consci_mod_pers$b[2], consci_mod_pers$se[2], consci_mod_pers$ci.lb[2], consci_mod_pers$ci.ub[2], consci_mod_pers$zval[2], consci_mod_pers$pval[2], 
  "Big 6",       consci_mod_pers$b[3], consci_mod_pers$se[3], consci_mod_pers$ci.lb[3], consci_mod_pers$ci.ub[3], consci_mod_pers$zval[3], consci_mod_pers$pval[3],
  "Other",       consci_mod_pers$b[4], consci_mod_pers$se[4], consci_mod_pers$ci.lb[4], consci_mod_pers$ci.ub[4], consci_mod_pers$zval[4], consci_mod_pers$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

consci_table_personality <- consci_table_personality %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

consci_table_personality <- add_header_lines(consci_table_personality, 
                                             values = c("Results of subgroup analysis for personality inventory.", "Table 4"))
consci_table_personality <- theme_booktabs(consci_table_personality)

consci_table_personality <- italic(consci_table_personality, italic = TRUE, part = "header")

consci_table_personality
```

#### Continent

```{r}
# Dropping NAs
consci_data_mod4 <- consci_data %>%
  drop_na(continent)

consci_mod_cont <- rma.mv(yi,
                          vi,
                          random = list(~ 1 | es_id, # level 2
                                        ~ 1 | study_id), # level 3
                          data = consci_data_mod4,
                          method = "REML",
                          tdist = TRUE,
                          mods = ~ continent)

consci_mod_cont
```

```{r}
consci_forest_continent <- viz_forest(x = consci_mod_cont,
                                      study_labels =  consci_data_mod4$short_ref,
                                      method = "REML",
                                      summary_label = c("Asia", "Europe", "North America", "Other"), 
                                      xlab = "Correlation",
                                      variant = "rain",
                                      text_size = 2, 
                                      annotate_CI = T)
```

##### Table

```{r}
consci_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      consci_mod_cont$b[1], consci_mod_cont$se[1], consci_mod_cont$ci.lb[1], consci_mod_cont$ci.ub[1], consci_mod_cont$zval[1], consci_mod_cont$pval[1], 
  "Europe",   consci_mod_cont$b[2], consci_mod_cont$se[2], consci_mod_cont$ci.lb[2], consci_mod_cont$ci.ub[2], consci_mod_cont$zval[2], consci_mod_cont$pval[2], 
  "North America",       consci_mod_cont$b[3], consci_mod_cont$se[3], consci_mod_cont$ci.lb[3], consci_mod_cont$ci.ub[3], consci_mod_cont$zval[3], consci_mod_cont$pval[3],
  "Other",       consci_mod_cont$b[4], consci_mod_cont$se[4], consci_mod_cont$ci.lb[4], consci_mod_cont$ci.ub[4], consci_mod_cont$zval[4], consci_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

consci_table_continent <- consci_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

consci_table_continent <- add_header_lines(consci_table_continent, 
                                           values = c("Results of subgroup analysis for continent.", "Table 5"))
consci_table_continent <- theme_booktabs(consci_table_continent)

consci_table_continent <- italic(consci_table_continent, italic = TRUE, part = "header")

consci_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = consci_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_personality_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
consci_data_center <- consci_data %>% 
  mutate(alpha_consci_mean = scale(alpha_consci, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
consci_alpha <- rma(yi, vi, 
                    random = list(~ 1 | es_id, # level 2
                                  ~ 1 | study_id), # level 3
                    data = consci_data_center, 
                    digits = 3,
                    mods = ~ 
                      alpha_consci_mean + alpha_ad_mean)

consci_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
consci_alpha$k
consci_alpha$b[1]
consci_alpha$ci.lb[1]
consci_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
consci_data_rem <- consci_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
consci_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = consci_data_rem, sm = "ZCOR",
                           method.tau = "REML")

consci_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
consci_data_rem <- escalc(measure = "ZCOR", 
                          ri = r, 
                          ni = sample_size, 
                          data = consci_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
consci_rem <- rma(yi, vi, 
                  data = consci_data_rem, 
                  slab = consci_data_rem$short_ref) 
consci_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(consci_rem) 
```

*** 
<br>

### Forest Plot

```{r}
consci_rem_forest <- viz_forest(consci_rem, 
                                summary_label = "Summary effect", 
                                study_labels = consci_data_rem$short_ref,
                                method = "REML",
                                xlab = "Correlation Coefficient", 
                                variant = "rain",
                                annotate_CI = TRUE, 
                                table_headers = "Correlation [95% CI]")
consci_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
consci_egger <- regtest(consci_rem)
consci_egger
```

*** 

<br>

### *p*-uniform

```{r}
consci_puniform <- puniform(ri = consci_data_rem$r, 
                            ni = consci_data_rem$N, 
                            alpha = .05,
                            side = "left", 
                            method = "P", 
                            plot = TRUE)

consci_puniform
```

Estimate: *r* = `r round(consci_puniform$est, 3)` 95% CI [`r round(consci_puniform$ci.lb, 3)`, `r round(consci_puniform$ci.ub, 3)`]
*k* = `r consci_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
consci_puniform_star <- puni_star(ri = consci_data_rem$r, 
                                  ni = consci_data_rem$N, 
                                  alpha = .05,
                                  side = "left", 
                                  method = "ML")
consci_puniform_star
```
Estimate: *r* = `r round(consci_puniform_star$est, 3)` 95% CI [`r round(consci_puniform_star$ci.lb, 3)`, `r round(consci_puniform_star$ci.ub, 3)`]

*k* = `r consci_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
consci_p_curve <- pcurve(consci_rem_meta, 
                         effect.estimation = TRUE, 
                         N = consci_data_rem$sample_size, 
                         dmin = 0, 
                         dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
consci_p_curve_est = consci_p_curve$dEstimate/sqrt(consci_p_curve$dEstimate^2 + 4)

consci_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
consci_petpeese <- PETPEESE.est(consci_data_rem$yi, consci_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

consci_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
consci_rem_sens <- leave1out(consci_rem, digits = 2)
round(min(consci_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(consci_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
consci_inf <- influence(consci_rem)

plot(consci_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
consci_baujat <- baujat(consci_rem, symbol = "slab")
consci_baujat
```

*** 

# 3. Extraversion

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
extra_data <- escalc(measure = "ZCOR", 
                     ri = r_extra, 
                     ni = sample_size, 
                     data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>%  # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
extra_mlm <- rma.mv(yi, 
                    vi, 
                    random = list(~ 1 | es_id, # level 2
                                  ~ 1 | study_id), # level 3
                    tdist = T, # Knapp-Hartung adjustment for confidence intervals
                    data = extra_data,
                    method = "REML")

summary(extra_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
extra_r <- predict(extra_mlm, digits = 3, transf = transf.ztor)

extra_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
extra_mlm_variance <- mlm.variance.distribution(x = extra_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
extra_mlm_level1 <- round(extra_mlm_variance[1, 1], 2)
extra_mlm_level1

extra_mlm_level2 <- round(extra_mlm_variance[2, 1], 2)
extra_mlm_level2

extra_mlm_level3 <- round(extra_mlm_variance[3, 1], 2)
extra_mlm_level3

extra_mlm_I2 <- sum(extra_mlm_level2, extra_mlm_level3)
extra_mlm_I2
```

`r extra_mlm_level1`% of the overall variance can be attributed to level 1, `r extra_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r extra_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r extra_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
extra_mlm.l2.removed <- rma.mv(yi, 
                               vi, 
                               random = list(~ 1 | es_id, # level 2
                                             ~ 1 | study_id), # level 3
                               tdist = T, # Knapp-Hartung adjustment for confidence intervals
                               data = extra_data,
                               method = "REML",
                               sigma2 = c(0, NA))

summary(extra_mlm.l2.removed)

anova(extra_mlm, extra_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
extra_mlm.l3.removed <- rma.mv(yi, 
                               vi, 
                               random = list(~ 1 | es_id, # level 2
                                             ~ 1 | study_id), # level 3
                               tdist = T, # Knapp-Hartung adjustment for confidence intervals
                               data = extra_data,
                               method = "REML",
                               sigma2 = c(0, NA))

summary(extra_mlm.l3.removed)

extra_mlm.l3.removed_anova <- anova(extra_mlm, extra_mlm.l3.removed)

extra_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

### Forest Plot
```{r}
extra_data_year <- extra_data %>% 
  arrange(year)

extra_mlm_forest <- viz_forest(extra_mlm, 
                               summary_label = "Summary effect", 
                               study_labels = extra_data$short_ref,
                               method = "REML",
                               xlab = "Correlation Coefficient", 
                               variant = "rain",
                               annotate_CI = TRUE, 
                               table_headers = "Correlation [95% CI]")

extra_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_extra.svg', width = 8, height = 11) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
extra_mlm_forest_mf <- forest(extra_mlm, 
                              slab = extra_data$short_ref,
                              addcred=F)

extra_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-3.4, 50, "Author(s) and Year",  pos=4)
text(3.2, 50, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
extra_mlm_funnel <- viz_funnel(x = extra_mlm, 
                               contours = TRUE,
                               trim_and_fill = F, 
                               egger = TRUE)

extra_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
extra_mod_age <- rma.mv(yi, 
                        vi, 
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = extra_data,
                        method = "REML",
                        tdist = TRUE, 
                        mods = ~ age_mean)
extra_mod_age
```

<br>

*F*(1, `r extra_mod_age$dfs`) = `r round(extra_mod_age$QM, 3)` *p* = `r round(extra_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(extra_data$vi)
size <- size / max(size)

extra_bubble_age <- ggplot(extra_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

extra_bubble_age
```




*** 
<br>

#### Sex

```{r}
extra_mod_sex <- rma.mv(yi, 
                        vi, 
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = extra_data,
                        method = "REML",
                        tdist = TRUE, 
                        mods = ~ perc_female)
extra_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(extra_data$vi)
size <- size / max(size)

extra_bubble_sex <- ggplot(extra_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

extra_bubble_sex
```

***
<br>

#### Study Quality

```{r}
extra_mod_quality <- rma.mv(yi, 
                            vi, 
                            random = list(~ 1 | es_id, # level 2
                                          ~ 1 | study_id), # level 3
                            data = extra_data,
                            method = "REML",
                            tdist = TRUE, 
                            mods = ~ mod_study_quality)
extra_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(extra_data$vi)
size <- size / max(size)

extra_bubble_quality <- ggplot(extra_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

extra_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
extra_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", extra_mod_age$k, extra_mod_age$b[2], extra_mod_age$se[2],  extra_mod_age$QM, extra_mod_age$QMp,
  "% Female", extra_mod_sex$k, extra_mod_sex$b[2], extra_mod_sex$se[2],  extra_mod_sex$QM, extra_mod_sex$QMp,
  "Study Quality", extra_mod_quality$k, extra_mod_quality$b[2], extra_mod_quality$se[2],  extra_mod_quality$QM, extra_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

extra_table_regression <- extra_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

extra_table_regression <- add_header_lines(extra_table_regression, 
                                           values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

extra_table_regression <- theme_booktabs(extra_table_regression)
extra_table_regression <- italic(extra_table_regression, italic = TRUE, part = "header")

extra_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
extra_data_mod1 <- extra_data %>%
  drop_na(mod_ad_inventory)

extra_mod_ad <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = extra_data_mod1,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ mod_ad_inventory)

extra_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
extra_forest_ad <- viz_forest(x = extra_mod_ad,
                              study_labels =  extra_data_mod1$short_ref,
                              method = "REML",
                              summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                              xlab = "Correlation",
                              variant = "rain",
                              text_size = 2, 
                              annotate_CI = T)

extra_forest_ad
```

##### Table 

```{r}
extra_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      extra_mod_ad$b[1], extra_mod_ad$se[1], extra_mod_ad$ci.lb[1], extra_mod_ad$ci.ub[1], extra_mod_ad$zval[1], extra_mod_ad$pval[1], 
  "Self-Constructed",   extra_mod_ad$b[2], extra_mod_ad$se[2], extra_mod_ad$ci.lb[2], extra_mod_ad$ci.ub[2], extra_mod_ad$zval[2], extra_mod_ad$pval[2], 
  "Validated",       extra_mod_ad$b[3], extra_mod_ad$se[3], extra_mod_ad$ci.lb[3], extra_mod_ad$ci.ub[3], extra_mod_ad$zval[3], extra_mod_ad$pval[3] 
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

extra_table_ad <- extra_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

extra_table_ad <- add_header_lines(extra_table_ad, 
                                   values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
extra_table_ad <- theme_booktabs(extra_table_ad)

extra_table_ad <- italic(extra_table_ad, italic = TRUE, part = "header")

extra_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# extra_data_mod2 <- extra_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = extra_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  extra_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Personality Inventory

```{r}
table(extra_data$mod_personality_inventory)
```


```{r}
# Dropping NAs
extra_data_mod3 <- extra_data %>%
  filter(mod_personality_inventory != "NA")

# calculating subgroup analyis
extra_mod_pers <- rma.mv(yi,
                         vi,
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = extra_data_mod3,
                         method = "REML",
                         tdist = TRUE,
                         mods = ~ mod_personality_inventory)

extra_mod_pers
```

<br>

##### Subgroup Forest Plot

```{r}
extra_forest_personality <- viz_forest(x = extra_mod_pers,
                                       study_labels =  extra_data_mod3$short_ref,
                                       method = "REML",
                                       summary_label = c("Big 5", "Big 5 Short", "Big 6", "Other"), 
                                       xlab = "Correlation",
                                       variant = "rain",
                                       text_size = 2, 
                                       annotate_CI = T)
```

##### Table

```{r}
extra_table_personality <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Big 5 ",      extra_mod_pers$b[1], extra_mod_pers$se[1], extra_mod_pers$ci.lb[1], extra_mod_pers$ci.ub[1], extra_mod_pers$zval[1], extra_mod_pers$pval[1], 
  "Big Short",   extra_mod_pers$b[2], extra_mod_pers$se[2], extra_mod_pers$ci.lb[2], extra_mod_pers$ci.ub[2], extra_mod_pers$zval[2], extra_mod_pers$pval[2], 
  "Big 6",       extra_mod_pers$b[3], extra_mod_pers$se[3], extra_mod_pers$ci.lb[3], extra_mod_pers$ci.ub[3], extra_mod_pers$zval[3], extra_mod_pers$pval[3],
  "Other",       extra_mod_pers$b[4], extra_mod_pers$se[4], extra_mod_pers$ci.lb[4], extra_mod_pers$ci.ub[4], extra_mod_pers$zval[4], extra_mod_pers$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

extra_table_personality <- extra_table_personality %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

extra_table_personality <- add_header_lines(extra_table_personality, 
                                            values = c("Results of subgroup analysis for personality inventory.", "Table 4"))
extra_table_personality <- theme_booktabs(extra_table_personality)

extra_table_personality <- italic(extra_table_personality, italic = TRUE, part = "header")

extra_table_personality
```

#### Continent

```{r}
# Dropping NAs
extra_data_mod4 <- extra_data %>%
  drop_na(continent)

extra_mod_cont <- rma.mv(yi,
                         vi,
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = extra_data_mod4,
                         method = "REML",
                         tdist = TRUE,
                         mods = ~ continent)

extra_mod_cont
```

```{r}
extra_forest_continent <- viz_forest(x = extra_mod_cont,
                                     study_labels =  extra_data_mod4$short_ref,
                                     method = "REML",
                                     summary_label = c("Asia", "Europe", "North America", "Other"), 
                                     xlab = "Correlation",
                                     variant = "rain",
                                     text_size = 2, 
                                     annotate_CI = T)
```

##### Table

```{r}
extra_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      extra_mod_cont$b[1], extra_mod_cont$se[1], extra_mod_cont$ci.lb[1], extra_mod_cont$ci.ub[1], extra_mod_cont$zval[1], extra_mod_cont$pval[1], 
  "Europe",   extra_mod_cont$b[2], extra_mod_cont$se[2], extra_mod_cont$ci.lb[2], extra_mod_cont$ci.ub[2], extra_mod_cont$zval[2], extra_mod_cont$pval[2], 
  "North America",       extra_mod_cont$b[3], extra_mod_cont$se[3], extra_mod_cont$ci.lb[3], extra_mod_cont$ci.ub[3], extra_mod_cont$zval[3], extra_mod_cont$pval[3],
  "Other",       extra_mod_cont$b[4], extra_mod_cont$se[4], extra_mod_cont$ci.lb[4], extra_mod_cont$ci.ub[4], extra_mod_cont$zval[4], extra_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

extra_table_continent <- extra_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

extra_table_continent <- add_header_lines(extra_table_continent, 
                                          values = c("Results of subgroup analysis for continent.", "Table 5"))
extra_table_continent <- theme_booktabs(extra_table_continent)

extra_table_continent <- italic(extra_table_continent, italic = TRUE, part = "header")

extra_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = extra_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_personality_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
extra_data_center <- extra_data %>% 
  mutate(alpha_extra_mean = scale(alpha_extra, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
extra_alpha <- rma(yi, vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   data = extra_data_center, 
                   digits = 3,
                   mods = ~ 
                     alpha_extra_mean + alpha_ad_mean)

extra_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
extra_alpha$k
extra_alpha$b[1]
extra_alpha$ci.lb[1]
extra_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
extra_data_rem <- extra_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
extra_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = extra_data_rem, sm = "ZCOR",
                          method.tau = "REML")

extra_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
extra_data_rem <- escalc(measure = "ZCOR", 
                         ri = r, 
                         ni = sample_size, 
                         data = extra_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
extra_rem <- rma(yi, vi, 
                 data = extra_data_rem, 
                 slab = extra_data_rem$short_ref) 
extra_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

### Forest Plot

```{r}
extra_rem_forest <- viz_forest(extra_rem, 
                               summary_label = "Summary effect", 
                               study_labels = extra_data_rem$short_ref,
                               method = "REML",
                               xlab = "Correlation Coefficient", 
                               variant = "rain",
                               annotate_CI = TRUE, 
                               table_headers = "Correlation [95% CI]")
extra_rem_forest
```

*** 
<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(extra_rem) 
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
extra_egger <- regtest(extra_rem)
extra_egger
```

*** 

<br>

### *p*-uniform

```{r}
extra_puniform <- puniform(ri = extra_data_rem$r, 
                           ni = extra_data_rem$N, 
                           alpha = .05,
                           side = "right", 
                           method = "P", 
                           plot = TRUE)

extra_puniform
```

Estimate: *r* = `r round(extra_puniform$est, 3)` 95% CI [`r round(extra_puniform$ci.lb, 3)`, `r round(extra_puniform$ci.ub, 3)`]
*k* = `r extra_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
extra_puniform_star <- puni_star(ri = extra_data_rem$r, 
                                 ni = extra_data_rem$N, 
                                 alpha = .05,
                                 side = "right", 
                                 method = "ML")
extra_puniform_star
```
Estimate: *r* = `r round(extra_puniform_star$est, 3)` 95% CI [`r round(extra_puniform_star$ci.lb, 3)`, `r round(extra_puniform_star$ci.ub, 3)`]

*k* = `r extra_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
extra_p_curve <- pcurve(extra_rem_meta, 
                        effect.estimation = TRUE, 
                        N = extra_data_rem$sample_size, 
                        dmin = 0, 
                        dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
extra_p_curve_est = extra_p_curve$dEstimate/sqrt(extra_p_curve$dEstimate^2 + 4)

extra_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
extra_petpeese <- PETPEESE.est(extra_data_rem$yi, extra_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

extra_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
extra_rem_sens <- leave1out(extra_rem, digits = 2)
round(min(extra_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(extra_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
extra_inf <- influence(extra_rem)

plot(extra_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
extra_baujat <- baujat(extra_rem, symbol = "slab")
extra_baujat
```

*** 

# 4. Agreeablness

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
agree_data <- escalc(measure = "ZCOR", 
                     ri = r_agree, 
                     ni = sample_size, 
                     data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
agree_mlm <- rma.mv(yi, 
                    vi, 
                    random = list(~ 1 | es_id, # level 2
                                  ~ 1 | study_id), # level 3
                    tdist = T, # Knapp-Hartung adjustment for confidence intervals
                    data = agree_data,
                    method = "REML")

summary(agree_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
agree_r <- predict(agree_mlm, digits = 3, transf = transf.ztor)

agree_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
agree_mlm_variance <- mlm.variance.distribution(x = agree_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
agree_mlm_level1 <- round(agree_mlm_variance[1, 1], 2)
agree_mlm_level1

agree_mlm_level2 <- round(agree_mlm_variance[2, 1], 2)
agree_mlm_level2

agree_mlm_level3 <- round(agree_mlm_variance[3, 1], 2)
agree_mlm_level3

agree_mlm_I2 <- sum(agree_mlm_level2, agree_mlm_level3)
agree_mlm_I2
```

`r agree_mlm_level1`% of the overall variance can be attributed to level 1, `r agree_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r agree_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r agree_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
agree_mlm.l2.removed <- rma.mv(yi, 
                               vi, 
                               random = list(~ 1 | es_id, # level 2
                                             ~ 1 | study_id), # level 3
                               tdist = T, # Knapp-Hartung adjustment for confidence intervals
                               data = agree_data,
                               method = "REML",
                               sigma2 = c(0, NA))

summary(agree_mlm.l2.removed)

anova(agree_mlm, agree_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
agree_mlm.l3.removed <- rma.mv(yi, 
                               vi, 
                               random = list(~ 1 | es_id, # level 2
                                             ~ 1 | study_id), # level 3
                               tdist = T, # Knapp-Hartung adjustment for confidence intervals
                               data = agree_data,
                               method = "REML",
                               sigma2 = c(0, NA))

summary(agree_mlm.l3.removed)

agree_mlm.l3.removed_anova <- anova(agree_mlm, agree_mlm.l3.removed)

agree_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot
```{r}
agree_data_year <- agree_data %>% 
  arrange(year)

agree_mlm_forest <- viz_forest(agree_mlm, 
                               summary_label = "Summary effect", 
                               study_labels = agree_data_year$short_ref,
                               method = "REML",
                               xlab = "Correlation Coefficient", 
                               variant = "rain",
                               annotate_CI = TRUE, 
                               table_headers = "Correlation [95% CI]")

agree_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_agree.svg', width = 8, height = 11) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
agree_mlm_forest_mf <- forest(agree_mlm, 
                              slab = agree_data$short_ref,
                              addcred=F)

agree_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-2.2, 47, "Author(s) and Year",  pos=4)
text(1.8, 47, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
agree_mlm_funnel <- viz_funnel(x = agree_mlm, 
                               contours = TRUE,
                               trim_and_fill = F, 
                               egger = TRUE)

agree_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
agree_mod_age <- rma.mv(yi, 
                        vi, 
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = agree_data,
                        method = "REML",
                        tdist = TRUE, 
                        mods = ~ age_mean)
agree_mod_age
```

<br>

*F*(1, `r agree_mod_age$dfs`) = `r round(agree_mod_age$QM, 3)` *p* = `r round(agree_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(agree_data$vi)
size <- size / max(size)

agree_bubble_age <- ggplot(agree_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

agree_bubble_age
```




*** 
<br>

#### Sex

```{r}
agree_mod_sex <- rma.mv(yi, 
                        vi, 
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = agree_data,
                        method = "REML",
                        tdist = TRUE, 
                        mods = ~ perc_female)
agree_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(agree_data$vi)
size <- size / max(size)

agree_bubble_sex <- ggplot(agree_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

agree_bubble_sex
```

***
<br>

#### Study Quality

```{r}
agree_mod_quality <- rma.mv(yi, 
                            vi, 
                            random = list(~ 1 | es_id, # level 2
                                          ~ 1 | study_id), # level 3
                            data = agree_data,
                            method = "REML",
                            tdist = TRUE, 
                            mods = ~ mod_study_quality)
agree_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(agree_data$vi)
size <- size / max(size)

agree_bubble_quality <- ggplot(agree_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

agree_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
agree_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", agree_mod_age$k, agree_mod_age$b[2], agree_mod_age$se[2],  agree_mod_age$QM, agree_mod_age$QMp,
  "% Female", agree_mod_sex$k, agree_mod_sex$b[2], agree_mod_sex$se[2],  agree_mod_sex$QM, agree_mod_sex$QMp,
  "Study Quality", agree_mod_quality$k, agree_mod_quality$b[2], agree_mod_quality$se[2],  agree_mod_quality$QM, agree_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

agree_table_regression <- agree_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

agree_table_regression <- add_header_lines(agree_table_regression, 
                                           values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

agree_table_regression <- theme_booktabs(agree_table_regression)
agree_table_regression <- italic(agree_table_regression, italic = TRUE, part = "header")

agree_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
agree_data_mod1 <- agree_data %>%
  drop_na(mod_ad_inventory)

agree_mod_ad <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = agree_data_mod1,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ mod_ad_inventory)

agree_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
agree_forest_ad <- viz_forest(x = agree_mod_ad,
                              study_labels =  agree_data_mod1$short_ref,
                              method = "REML",
                              summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                              xlab = "Correlation",
                              variant = "rain",
                              text_size = 2, 
                              annotate_CI = T)

agree_forest_ad
```

##### Table 

```{r}
agree_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      agree_mod_ad$b[1], agree_mod_ad$se[1], agree_mod_ad$ci.lb[1], agree_mod_ad$ci.ub[1], agree_mod_ad$zval[1], agree_mod_ad$pval[1], 
  "Self-Constructed",   agree_mod_ad$b[2], agree_mod_ad$se[2], agree_mod_ad$ci.lb[2], agree_mod_ad$ci.ub[2], agree_mod_ad$zval[2], agree_mod_ad$pval[2], 
  "Validated",       agree_mod_ad$b[3], agree_mod_ad$se[3], agree_mod_ad$ci.lb[3], agree_mod_ad$ci.ub[3], agree_mod_ad$zval[3], agree_mod_ad$pval[3] 
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

agree_table_ad <- agree_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

agree_table_ad <- add_header_lines(agree_table_ad, 
                                   values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
agree_table_ad <- theme_booktabs(agree_table_ad)

agree_table_ad <- italic(agree_table_ad, italic = TRUE, part = "header")

agree_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# agree_data_mod2 <- agree_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = agree_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  agree_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Personality Inventory

```{r}
table(agree_data$mod_personality_inventory)
```


```{r}
# Dropping NAs
agree_data_mod3 <- agree_data %>%
  filter(mod_personality_inventory != "NA")

# calculating subgroup analyis
agree_mod_pers <- rma.mv(yi,
                         vi,
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = agree_data_mod3,
                         method = "REML",
                         tdist = TRUE,
                         mods = ~ mod_personality_inventory)

agree_mod_pers
```

<br>

##### Subgroup Forest Plot

```{r}
agree_forest_personality <- viz_forest(x = agree_mod_pers,
                                       study_labels =  agree_data_mod3$short_ref,
                                       method = "REML",
                                       summary_label = c("Big 5", "Big 5 Short", "Big 6", "Other"), 
                                       xlab = "Correlation",
                                       variant = "rain",
                                       text_size = 2, 
                                       annotate_CI = T)
```

##### Table

```{r}
agree_table_personality <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Big 5 ",      agree_mod_pers$b[1], agree_mod_pers$se[1], agree_mod_pers$ci.lb[1], agree_mod_pers$ci.ub[1], agree_mod_pers$zval[1], agree_mod_pers$pval[1], 
  "Big Short",   agree_mod_pers$b[2], agree_mod_pers$se[2], agree_mod_pers$ci.lb[2], agree_mod_pers$ci.ub[2], agree_mod_pers$zval[2], agree_mod_pers$pval[2], 
  "Big 6",       agree_mod_pers$b[3], agree_mod_pers$se[3], agree_mod_pers$ci.lb[3], agree_mod_pers$ci.ub[3], agree_mod_pers$zval[3], agree_mod_pers$pval[3],
  "Other",       agree_mod_pers$b[4], agree_mod_pers$se[4], agree_mod_pers$ci.lb[4], agree_mod_pers$ci.ub[4], agree_mod_pers$zval[4], agree_mod_pers$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

agree_table_personality <- agree_table_personality %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

agree_table_personality <- add_header_lines(agree_table_personality, 
                                            values = c("Results of subgroup analysis for personality inventory.", "Table 4"))
agree_table_personality <- theme_booktabs(agree_table_personality)

agree_table_personality <- italic(agree_table_personality, italic = TRUE, part = "header")

agree_table_personality
```

#### Continent

```{r}
# Dropping NAs
agree_data_mod4 <- agree_data %>%
  drop_na(continent)

agree_mod_cont <- rma.mv(yi,
                         vi,
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = agree_data_mod4,
                         method = "REML",
                         tdist = TRUE,
                         mods = ~ continent)

agree_mod_cont
```

```{r}
agree_forest_continent <- viz_forest(x = agree_mod_cont,
                                     study_labels =  agree_data_mod4$short_ref,
                                     method = "REML",
                                     summary_label = c("Asia", "Europe", "North America", "Other"), 
                                     xlab = "Correlation",
                                     variant = "rain",
                                     text_size = 2, 
                                     annotate_CI = T)
```

##### Table

```{r}
agree_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      agree_mod_cont$b[1], agree_mod_cont$se[1], agree_mod_cont$ci.lb[1], agree_mod_cont$ci.ub[1], agree_mod_cont$zval[1], agree_mod_cont$pval[1], 
  "Europe",   agree_mod_cont$b[2], agree_mod_cont$se[2], agree_mod_cont$ci.lb[2], agree_mod_cont$ci.ub[2], agree_mod_cont$zval[2], agree_mod_cont$pval[2], 
  "North America",       agree_mod_cont$b[3], agree_mod_cont$se[3], agree_mod_cont$ci.lb[3], agree_mod_cont$ci.ub[3], agree_mod_cont$zval[3], agree_mod_cont$pval[3],
  "Other",       agree_mod_cont$b[4], agree_mod_cont$se[4], agree_mod_cont$ci.lb[4], agree_mod_cont$ci.ub[4], agree_mod_cont$zval[4], agree_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

agree_table_continent <- agree_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

agree_table_continent <- add_header_lines(agree_table_continent, 
                                          values = c("Results of subgroup analysis for continent.", "Table 5"))
agree_table_continent <- theme_booktabs(agree_table_continent)

agree_table_continent <- italic(agree_table_continent, italic = TRUE, part = "header")

agree_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = agree_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_personality_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
agree_data_center <- agree_data %>% 
  mutate(alpha_agree_mean = scale(alpha_agree, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
agree_alpha <- rma(yi, vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   data = agree_data_center, 
                   digits = 3,
                   mods = ~ 
                     alpha_agree_mean + alpha_ad_mean)

agree_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
agree_alpha$k
agree_alpha$b[1]
agree_alpha$ci.lb[1]
agree_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
agree_data_rem <- agree_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
agree_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = agree_data_rem, sm = "ZCOR",
                          method.tau = "REML")

agree_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
agree_data_rem <- escalc(measure = "ZCOR", 
                         ri = r, 
                         ni = sample_size, 
                         data = agree_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
agree_rem <- rma(yi, vi, 
                 data = agree_data_rem, 
                 slab = agree_data_rem$short_ref) 
agree_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(agree_rem) 
```

*** 
<br>

### Forest Plot

```{r}
agree_rem_forest <- viz_forest(agree_rem, 
                               summary_label = "Summary effect", 
                               study_labels = agree_data_rem$short_ref,
                               method = "REML",
                               xlab = "Correlation Coefficient", 
                               variant = "rain",
                               annotate_CI = TRUE, 
                               table_headers = "Correlation [95% CI]")

agree_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
agree_egger <- regtest(agree_rem)
agree_egger
```

*** 

<br>

### *p*-uniform

```{r}
agree_puniform <- puniform(ri = agree_data_rem$r, 
                           ni = agree_data_rem$N, 
                           alpha = .05,
                           side = "left", 
                           method = "P", 
                           plot = TRUE)

agree_puniform
```

Estimate: *r* = `r round(agree_puniform$est, 3)` 95% CI [`r round(agree_puniform$ci.lb, 3)`, `r round(agree_puniform$ci.ub, 3)`]
*k* = `r agree_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
agree_puniform_star <- puni_star(ri = agree_data_rem$r, 
                                 ni = agree_data_rem$N, 
                                 alpha = .05,
                                 side = "left", 
                                 method = "ML")
agree_puniform_star
```
Estimate: *r* = `r round(agree_puniform_star$est, 3)` 95% CI [`r round(agree_puniform_star$ci.lb, 3)`, `r round(agree_puniform_star$ci.ub, 3)`]

*k* = `r agree_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
agree_p_curve <- pcurve(agree_rem_meta, 
                        effect.estimation = TRUE, 
                        N = agree_data_rem$sample_size, 
                        dmin = 0, 
                        dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
agree_p_curve_est = agree_p_curve$dEstimate/sqrt(agree_p_curve$dEstimate^2 + 4)

agree_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
agree_petpeese <- PETPEESE.est(agree_data_rem$yi, agree_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

agree_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
agree_rem_sens <- leave1out(agree_rem, digits = 2)
round(min(agree_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(agree_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
agree_inf <- influence(agree_rem)

plot(agree_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
agree_baujat <- baujat(agree_rem, symbol = "slab")
agree_baujat
```

*** 

# 5. Neuroticism

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
neuro_data <- escalc(measure = "ZCOR", 
                     ri = r_neuro, 
                     ni = sample_size, 
                     data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
neuro_mlm <- rma.mv(yi, 
                    vi, 
                    random = list(~ 1 | es_id, # level 2
                                  ~ 1 | study_id), # level 3
                    tdist = T, # Knapp-Hartung adjustment for confidence intervals
                    data = neuro_data,
                    method = "REML")

summary(neuro_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
neuro_r <- predict(neuro_mlm, digits = 3, transf = transf.ztor)

neuro_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
neuro_mlm_variance <- mlm.variance.distribution(x = neuro_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
neuro_mlm_level1 <- round(neuro_mlm_variance[1, 1], 2)
neuro_mlm_level1

neuro_mlm_level2 <- round(neuro_mlm_variance[2, 1], 2)
neuro_mlm_level2

neuro_mlm_level3 <- round(neuro_mlm_variance[3, 1], 2)
neuro_mlm_level3

neuro_mlm_I2 <- sum(neuro_mlm_level2, neuro_mlm_level3)
neuro_mlm_I2
```

`r neuro_mlm_level1`% of the overall variance can be attributed to level 1, `r neuro_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r neuro_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r neuro_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
neuro_mlm.l2.removed <- rma.mv(yi, 
                               vi, 
                               random = list(~ 1 | es_id, # level 2
                                             ~ 1 | study_id), # level 3
                               tdist = T, # Knapp-Hartung adjustment for confidence intervals
                               data = neuro_data,
                               method = "REML",
                               sigma2 = c(0, NA))

summary(neuro_mlm.l2.removed)

anova(neuro_mlm, neuro_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
neuro_mlm.l3.removed <- rma.mv(yi, 
                               vi, 
                               random = list(~ 1 | es_id, # level 2
                                             ~ 1 | study_id), # level 3
                               tdist = T, # Knapp-Hartung adjustment for confidence intervals
                               data = neuro_data,
                               method = "REML",
                               sigma2 = c(0, NA))

summary(neuro_mlm.l3.removed)

neuro_mlm.l3.removed_anova <- anova(neuro_mlm, neuro_mlm.l3.removed)

neuro_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

### Forest Plot
```{r}
neuro_data_year <- neuro_data %>% 
  arrange(year)

neuro_mlm_forest <- viz_forest(neuro_mlm, 
                               summary_label = "Summary effect", 
                               study_labels = neuro_data_year$short_ref,
                               method = "REML",
                               xlab = "Correlation Coefficient", 
                               variant = "rain",
                               annotate_CI = TRUE, 
                               table_headers = "Correlation [95% CI]")

neuro_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_neuro.svg', width = 8, height = 11) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
neuro_mlm_forest_mf <- forest(neuro_mlm, 
                              slab = neuro_data$short_ref,
                              addcred=F)

neuro_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-1.3, 55, "Author(s) and Year",  pos=4)
text(1.3, 55, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
neuro_mlm_funnel <- viz_funnel(x = neuro_mlm, 
                               contours = TRUE,
                               trim_and_fill = F, 
                               egger = TRUE)

neuro_mlm_funnel
```
```{r}
## REML Funnel plot
viz_funnel(x = neuro_mlm, method = "REML",
           contours = TRUE,
           xlab = "Observed outcome")
```


```{r}
## Fixed effect funnel plot with REML ES line
viz_funnel(x = neuro_mlm, method = "FE",
           contours = TRUE,
           xlab = "Observed outcome") +
  ggplot2::geom_vline(xintercept = neuro_mlm$b, linetype = "dashed")

```


*** 
<br>

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
neuro_mod_age <- rma.mv(yi, 
                        vi, 
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = neuro_data,
                        method = "REML",
                        tdist = TRUE, 
                        mods = ~ age_mean)
neuro_mod_age
```

<br>

*F*(1, `r neuro_mod_age$dfs`) = `r round(neuro_mod_age$QM, 3)` *p* = `r round(neuro_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(neuro_data$vi)
size <- size / max(size)

neuro_bubble_age <- ggplot(neuro_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

neuro_bubble_age
```




*** 
<br>

#### Sex

```{r}
neuro_mod_sex <- rma.mv(yi, 
                        vi, 
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = neuro_data,
                        method = "REML",
                        tdist = TRUE, 
                        mods = ~ perc_female)
neuro_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(neuro_data$vi)
size <- size / max(size)

neuro_bubble_sex <- ggplot(neuro_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

neuro_bubble_sex
```

***
<br>

#### Study Quality

```{r}
neuro_mod_quality <- rma.mv(yi, 
                            vi, 
                            random = list(~ 1 | es_id, # level 2
                                          ~ 1 | study_id), # level 3
                            data = neuro_data,
                            method = "REML",
                            tdist = TRUE, 
                            mods = ~ mod_study_quality)
neuro_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(neuro_data$vi)
size <- size / max(size)

neuro_bubble_quality <- ggplot(neuro_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

neuro_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
neuro_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", neuro_mod_age$k, neuro_mod_age$b[2], neuro_mod_age$se[2],  neuro_mod_age$QM, neuro_mod_age$QMp,
  "% Female", neuro_mod_sex$k, neuro_mod_sex$b[2], neuro_mod_sex$se[2],  neuro_mod_sex$QM, neuro_mod_sex$QMp,
  "Study Quality", neuro_mod_quality$k, neuro_mod_quality$b[2], neuro_mod_quality$se[2],  neuro_mod_quality$QM, neuro_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

neuro_table_regression <- neuro_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

neuro_table_regression <- add_header_lines(neuro_table_regression, 
                                           values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

neuro_table_regression <- theme_booktabs(neuro_table_regression)
neuro_table_regression <- italic(neuro_table_regression, italic = TRUE, part = "header")

neuro_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
neuro_data_mod1 <- neuro_data %>%
  drop_na(mod_ad_inventory)

neuro_mod_ad <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = neuro_data_mod1,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ mod_ad_inventory)

neuro_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
neuro_forest_ad <- viz_forest(x = neuro_mod_ad,
                              study_labels =  neuro_data_mod1$short_ref,
                              method = "REML",
                              summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                              xlab = "Correlation",
                              variant = "rain",
                              text_size = 2, 
                              annotate_CI = T)

neuro_forest_ad
```

##### Table 

```{r}
neuro_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      neuro_mod_ad$b[1], neuro_mod_ad$se[1], neuro_mod_ad$ci.lb[1], neuro_mod_ad$ci.ub[1], neuro_mod_ad$zval[1], neuro_mod_ad$pval[1], 
  "Self-Constructed",   neuro_mod_ad$b[2], neuro_mod_ad$se[2], neuro_mod_ad$ci.lb[2], neuro_mod_ad$ci.ub[2], neuro_mod_ad$zval[2], neuro_mod_ad$pval[2], 
  "Validated",       neuro_mod_ad$b[3], neuro_mod_ad$se[3], neuro_mod_ad$ci.lb[3], neuro_mod_ad$ci.ub[3], neuro_mod_ad$zval[3], neuro_mod_ad$pval[3] 
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

neuro_table_ad <- neuro_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

neuro_table_ad <- add_header_lines(neuro_table_ad, 
                                   values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
neuro_table_ad <- theme_booktabs(neuro_table_ad)

neuro_table_ad <- italic(neuro_table_ad, italic = TRUE, part = "header")

neuro_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# neuro_data_mod2 <- neuro_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = neuro_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  neuro_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Personality Inventory

```{r}
table(neuro_data$mod_personality_inventory)
```


```{r}
# Dropping NAs
neuro_data_mod3 <- neuro_data %>%
  filter(mod_personality_inventory != "NA")

# calculating subgroup analyis
neuro_mod_pers <- rma.mv(yi,
                         vi,
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = neuro_data_mod3,
                         method = "REML",
                         tdist = TRUE,
                         mods = ~ mod_personality_inventory)

neuro_mod_pers
```

<br>

##### Subgroup Forest Plot

```{r}
neuro_forest_personality <- viz_forest(x = neuro_mod_pers,
                                       study_labels =  neuro_data_mod3$short_ref,
                                       method = "REML",
                                       summary_label = c("Big 5", "Big 5 Short", "Big 6", "Other"), 
                                       xlab = "Correlation",
                                       variant = "rain",
                                       text_size = 2, 
                                       annotate_CI = T)

neuro_forest_personality
```

##### Table

```{r}
neuro_table_personality <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Big 5 ",      neuro_mod_pers$b[1], neuro_mod_pers$se[1], neuro_mod_pers$ci.lb[1], neuro_mod_pers$ci.ub[1], neuro_mod_pers$zval[1], neuro_mod_pers$pval[1], 
  "Big Short",   neuro_mod_pers$b[2], neuro_mod_pers$se[2], neuro_mod_pers$ci.lb[2], neuro_mod_pers$ci.ub[2], neuro_mod_pers$zval[2], neuro_mod_pers$pval[2], 
  "Big 6",       neuro_mod_pers$b[3], neuro_mod_pers$se[3], neuro_mod_pers$ci.lb[3], neuro_mod_pers$ci.ub[3], neuro_mod_pers$zval[3], neuro_mod_pers$pval[3],
  "Other",       neuro_mod_pers$b[4], neuro_mod_pers$se[4], neuro_mod_pers$ci.lb[4], neuro_mod_pers$ci.ub[4], neuro_mod_pers$zval[4], neuro_mod_pers$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

neuro_table_personality <- neuro_table_personality %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

neuro_table_personality <- add_header_lines(neuro_table_personality, 
                                            values = c("Results of subgroup analysis for personality inventory.", "Table 4"))
neuro_table_personality <- theme_booktabs(neuro_table_personality)

neuro_table_personality <- italic(neuro_table_personality, italic = TRUE, part = "header")

neuro_table_personality
```

#### Continent

```{r}
# Dropping NAs
neuro_data_mod4 <- neuro_data %>%
  drop_na(continent)

neuro_mod_cont <- rma.mv(yi,
                         vi,
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = neuro_data_mod4,
                         method = "REML",
                         tdist = TRUE,
                         mods = ~ continent)

neuro_mod_cont
```

```{r}
neuro_forest_continent <- viz_forest(x = neuro_mod_cont,
                                     study_labels =  neuro_data_mod4$short_ref,
                                     method = "REML",
                                     summary_label = c("Asia", "Europe", "North America", "Other"), 
                                     xlab = "Correlation",
                                     variant = "rain",
                                     text_size = 2, 
                                     annotate_CI = T)
```

##### Table

```{r}
neuro_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      neuro_mod_cont$b[1], neuro_mod_cont$se[1], neuro_mod_cont$ci.lb[1], neuro_mod_cont$ci.ub[1], neuro_mod_cont$zval[1], neuro_mod_cont$pval[1], 
  "Europe",   neuro_mod_cont$b[2], neuro_mod_cont$se[2], neuro_mod_cont$ci.lb[2], neuro_mod_cont$ci.ub[2], neuro_mod_cont$zval[2], neuro_mod_cont$pval[2], 
  "North America",       neuro_mod_cont$b[3], neuro_mod_cont$se[3], neuro_mod_cont$ci.lb[3], neuro_mod_cont$ci.ub[3], neuro_mod_cont$zval[3], neuro_mod_cont$pval[3],
  "Other",       neuro_mod_cont$b[4], neuro_mod_cont$se[4], neuro_mod_cont$ci.lb[4], neuro_mod_cont$ci.ub[4], neuro_mod_cont$zval[4], neuro_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

neuro_table_continent <- neuro_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

neuro_table_continent <- add_header_lines(neuro_table_continent, 
                                          values = c("Results of subgroup analysis for continent.", "Table 5"))
neuro_table_continent <- theme_booktabs(neuro_table_continent)

neuro_table_continent <- italic(neuro_table_continent, italic = TRUE, part = "header")

neuro_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = neuro_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_personality_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
neuro_data_center <- neuro_data %>% 
  mutate(alpha_neuro_mean = scale(alpha_neuro, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
neuro_alpha <- rma(yi, vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   data = neuro_data_center, 
                   digits = 3,
                   mods = ~ 
                     alpha_neuro_mean + alpha_ad_mean)

neuro_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
neuro_alpha$k
neuro_alpha$b[1]
neuro_alpha$ci.lb[1]
neuro_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
neuro_data_rem <- neuro_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
neuro_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = neuro_data_rem, sm = "ZCOR",
                          method.tau = "REML")

neuro_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
neuro_data_rem <- escalc(measure = "ZCOR", 
                         ri = r, 
                         ni = sample_size, 
                         data = neuro_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
neuro_rem <- rma(yi, vi, 
                 data = neuro_data_rem, 
                 slab = neuro_data_rem$short_ref) 
neuro_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(neuro_rem) 
```

*** 
<br>

### Forest Plot

```{r}
neuro_rem_forest <- viz_forest(neuro_rem, 
                               summary_label = "Summary effect", 
                               study_labels = neuro_data_rem$short_ref,
                               method = "REML",
                               xlab = "Correlation Coefficient", 
                               variant = "rain",
                               annotate_CI = TRUE, 
                               table_headers = "Correlation [95% CI]")
neuro_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
neuro_egger <- regtest(neuro_rem)
neuro_egger
```

*** 

<br>

### *p*-uniform

```{r}
neuro_puniform <- puniform(ri = neuro_data_rem$r, 
                           ni = neuro_data_rem$N, 
                           alpha = .05,
                           side = "right", 
                           method = "P", 
                           plot = TRUE)

neuro_puniform
```

Estimate: *r* = `r round(neuro_puniform$est, 3)` 95% CI [`r round(neuro_puniform$ci.lb, 3)`, `r round(neuro_puniform$ci.ub, 3)`]
*k* = `r neuro_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
neuro_puniform_star <- puni_star(ri = neuro_data_rem$r, 
                                 ni = neuro_data_rem$N, 
                                 alpha = .05,
                                 side = "right", 
                                 method = "ML")
neuro_puniform_star
```
Estimate: *r* = `r round(neuro_puniform_star$est, 3)` 95% CI [`r round(neuro_puniform_star$ci.lb, 3)`, `r round(neuro_puniform_star$ci.ub, 3)`]

*k* = `r neuro_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
neuro_p_curve <- pcurve(neuro_rem_meta, 
                        effect.estimation = TRUE, 
                        N = neuro_data_rem$sample_size, 
                        dmin = 0, 
                        dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
neuro_p_curve_est = neuro_p_curve$dEstimate/sqrt(neuro_p_curve$dEstimate^2 + 4)

neuro_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
neuro_petpeese <- PETPEESE.est(neuro_data_rem$yi, neuro_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

neuro_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
neuro_rem_sens <- leave1out(neuro_rem, digits = 2)
round(min(neuro_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(neuro_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
neuro_inf <- influence(neuro_rem)

plot(neuro_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
neuro_baujat <- baujat(neuro_rem, symbol = "slab")
neuro_baujat
```

*** 

# 6. Honesty

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
hh_data <- escalc(measure = "ZCOR", 
                  ri = r_hh, 
                  ni = sample_size, 
                  data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
hh_mlm <- rma.mv(yi, 
                 vi, 
                 random = list(~ 1 | es_id, # level 2
                               ~ 1 | study_id), # level 3
                 tdist = T, # Knapp-Hartung adjustment for confidence intervals
                 data = hh_data,
                 method = "REML")

summary(hh_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
hh_r <- predict(hh_mlm, digits = 3, transf = transf.ztor)

hh_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
hh_mlm_variance <- mlm.variance.distribution(x = hh_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
hh_mlm_level1 <- round(hh_mlm_variance[1, 1], 2)
hh_mlm_level1

hh_mlm_level2 <- round(hh_mlm_variance[2, 1], 2)
hh_mlm_level2

hh_mlm_level3 <- round(hh_mlm_variance[3, 1], 2)
hh_mlm_level3

hh_mlm_I2 <- sum(hh_mlm_level2, hh_mlm_level3)
hh_mlm_I2
```

`r hh_mlm_level1`% of the overall variance can be attributed to level 1, `r hh_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r hh_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r hh_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
hh_mlm.l2.removed <- rma.mv(yi, 
                            vi, 
                            random = list(~ 1 | es_id, # level 2
                                          ~ 1 | study_id), # level 3
                            tdist = T, # Knapp-Hartung adjustment for confidence intervals
                            data = hh_data,
                            method = "REML",
                            sigma2 = c(0, NA))

summary(hh_mlm.l2.removed)

anova(hh_mlm, hh_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
hh_mlm.l3.removed <- rma.mv(yi, 
                            vi, 
                            random = list(~ 1 | es_id, # level 2
                                          ~ 1 | study_id), # level 3
                            tdist = T, # Knapp-Hartung adjustment for confidence intervals
                            data = hh_data,
                            method = "REML",
                            sigma2 = c(0, NA))

summary(hh_mlm.l3.removed)

hh_mlm.l3.removed_anova <- anova(hh_mlm, hh_mlm.l3.removed)

hh_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot
```{r}
hh_data_year <- hh_data %>% 
  arrange(year)

hh_mlm_forest <- viz_forest(hh_mlm, 
                            summary_label = "Summary effect", 
                            study_labels = hh_data_year$short_ref,
                            method = "REML",
                            xlab = "Correlation Coefficient", 
                            variant = "rain",
                            annotate_CI = TRUE, 
                            table_headers = "Correlation [95% CI]")

hh_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_hh.svg', width = 11, height = 9) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
hh_mlm_forest_mf <- forest(hh_mlm, 
                           slab = hh_data$short_ref,
                           addcred=F)

hh_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-1.24, 6.5, "Author(s) and Year",  pos=4)
text(.7, 6.5, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

#### Funnel Plot
```{r}
# Show Egger's regression line:
hh_mlm_funnel <- viz_funnel(x = hh_mlm, 
                            contours = TRUE,
                            trim_and_fill = F, 
                            egger = TRUE)

hh_mlm_funnel
```

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
hh_mod_age <- rma.mv(yi, 
                     vi, 
                     random = list(~ 1 | es_id, # level 2
                                   ~ 1 | study_id), # level 3
                     data = hh_data,
                     method = "REML",
                     tdist = TRUE, 
                     mods = ~ age_mean)
hh_mod_age
```

<br>

*F*(1, `r hh_mod_age$dfs`) = `r round(hh_mod_age$QM, 3)` *p* = `r round(hh_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(hh_data$vi)
size <- size / max(size)

hh_bubble_age <- ggplot(hh_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

hh_bubble_age
```




*** 
<br>

#### Sex

```{r}
hh_mod_sex <- rma.mv(yi, 
                     vi, 
                     random = list(~ 1 | es_id, # level 2
                                   ~ 1 | study_id), # level 3
                     data = hh_data,
                     method = "REML",
                     tdist = TRUE, 
                     mods = ~ perc_female)
hh_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(hh_data$vi)
size <- size / max(size)

hh_bubble_sex <- ggplot(hh_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

hh_bubble_sex
```

***
<br>

#### Study Quality

```{r}
hh_mod_quality <- rma.mv(yi, 
                         vi, 
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = hh_data,
                         method = "REML",
                         tdist = TRUE, 
                         mods = ~ mod_study_quality)
hh_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(hh_data$vi)
size <- size / max(size)

hh_bubble_quality <- ggplot(hh_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

hh_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
hh_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", hh_mod_age$k, hh_mod_age$b[2], hh_mod_age$se[2],  hh_mod_age$QM, hh_mod_age$QMp,
  "% Female", hh_mod_sex$k, hh_mod_sex$b[2], hh_mod_sex$se[2],  hh_mod_sex$QM, hh_mod_sex$QMp,
  "Study Quality", hh_mod_quality$k, hh_mod_quality$b[2], hh_mod_quality$se[2],  hh_mod_quality$QM, hh_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

hh_table_regression <- hh_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

hh_table_regression <- add_header_lines(hh_table_regression, 
                                        values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

hh_table_regression <- theme_booktabs(hh_table_regression)
hh_table_regression <- italic(hh_table_regression, italic = TRUE, part = "header")

hh_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
hh_data_mod1 <- hh_data %>%
  drop_na(mod_ad_inventory)

hh_mod_ad <- rma.mv(yi,
                    vi,
                    random = list(~ 1 | es_id, # level 2
                                  ~ 1 | study_id), # level 3
                    data = hh_data_mod1,
                    method = "REML",
                    tdist = TRUE,
                    mods = ~ mod_ad_inventory)

hh_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
hh_forest_ad <- viz_forest(x = hh_mod_ad,
                           study_labels =  hh_data_mod1$short_ref,
                           method = "REML",
                           summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                           xlab = "Correlation",
                           variant = "rain",
                           text_size = 2, 
                           annotate_CI = T)

hh_forest_ad
```

##### Table 

```{r}
hh_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      hh_mod_ad$b[1], hh_mod_ad$se[1], hh_mod_ad$ci.lb[1], hh_mod_ad$ci.ub[1], hh_mod_ad$zval[1], hh_mod_ad$pval[1], 
  "Self-Constructed",   hh_mod_ad$b[2], hh_mod_ad$se[2], hh_mod_ad$ci.lb[2], hh_mod_ad$ci.ub[2], hh_mod_ad$zval[2], hh_mod_ad$pval[2], 
  "Validated",       hh_mod_ad$b[3], hh_mod_ad$se[3], hh_mod_ad$ci.lb[3], hh_mod_ad$ci.ub[3], hh_mod_ad$zval[3], hh_mod_ad$pval[3] 
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

hh_table_ad <- hh_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

hh_table_ad <- add_header_lines(hh_table_ad, 
                                values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
hh_table_ad <- theme_booktabs(hh_table_ad)

hh_table_ad <- italic(hh_table_ad, italic = TRUE, part = "header")

hh_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# hh_data_mod2 <- hh_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = hh_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  hh_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Personality Inventory

```{r}
table(hh_data$mod_personality_inventory)
```


```{r}
# Dropping NAs
hh_data_mod3 <- hh_data %>%
  filter(mod_personality_inventory != "NA")

# calculating subgroup analyis
hh_mod_pers <- rma.mv(yi,
                      vi,
                      random = list(~ 1 | es_id, # level 2
                                    ~ 1 | study_id), # level 3
                      data = hh_data_mod3,
                      method = "REML",
                      tdist = TRUE,
                      mods = ~ mod_personality_inventory)

hh_mod_pers
```

<br>

##### Subgroup Forest Plot

```{r}
hh_forest_personality <- viz_forest(x = hh_mod_pers,
                                    study_labels =  hh_data_mod3$short_ref,
                                    method = "REML",
                                    summary_label = c("Big 5", "Big 5 Short", "Big 6", "Other"), 
                                    xlab = "Correlation",
                                    variant = "rain",
                                    text_size = 2, 
                                    annotate_CI = T)
```

##### Table

```{r}
hh_table_personality <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Big 5 ",      hh_mod_pers$b[1], hh_mod_pers$se[1], hh_mod_pers$ci.lb[1], hh_mod_pers$ci.ub[1], hh_mod_pers$zval[1], hh_mod_pers$pval[1], 
  "Big Short",   hh_mod_pers$b[2], hh_mod_pers$se[2], hh_mod_pers$ci.lb[2], hh_mod_pers$ci.ub[2], hh_mod_pers$zval[2], hh_mod_pers$pval[2], 
  "Big 6",       hh_mod_pers$b[3], hh_mod_pers$se[3], hh_mod_pers$ci.lb[3], hh_mod_pers$ci.ub[3], hh_mod_pers$zval[3], hh_mod_pers$pval[3],
  "Other",       hh_mod_pers$b[4], hh_mod_pers$se[4], hh_mod_pers$ci.lb[4], hh_mod_pers$ci.ub[4], hh_mod_pers$zval[4], hh_mod_pers$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

hh_table_personality <- hh_table_personality %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

hh_table_personality <- add_header_lines(hh_table_personality, 
                                         values = c("Results of subgroup analysis for personality inventory.", "Table 4"))
hh_table_personality <- theme_booktabs(hh_table_personality)

hh_table_personality <- italic(hh_table_personality, italic = TRUE, part = "header")

hh_table_personality
```

#### Continent

```{r}
# Dropping NAs
hh_data_mod4 <- hh_data %>%
  drop_na(continent)

hh_mod_cont <- rma.mv(yi,
                      vi,
                      random = list(~ 1 | es_id, # level 2
                                    ~ 1 | study_id), # level 3
                      data = hh_data_mod4,
                      method = "REML",
                      tdist = TRUE,
                      mods = ~ continent)

hh_mod_cont
```

```{r}
hh_forest_continent <- viz_forest(x = hh_mod_cont,
                                  study_labels =  hh_data_mod4$short_ref,
                                  method = "REML",
                                  summary_label = c("Asia", "Europe", "North America", "Other"), 
                                  xlab = "Correlation",
                                  variant = "rain",
                                  text_size = 2, 
                                  annotate_CI = T)
```

##### Table

```{r}
hh_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      hh_mod_cont$b[1], hh_mod_cont$se[1], hh_mod_cont$ci.lb[1], hh_mod_cont$ci.ub[1], hh_mod_cont$zval[1], hh_mod_cont$pval[1], 
  "Europe",   hh_mod_cont$b[2], hh_mod_cont$se[2], hh_mod_cont$ci.lb[2], hh_mod_cont$ci.ub[2], hh_mod_cont$zval[2], hh_mod_cont$pval[2], 
  "North America",       hh_mod_cont$b[3], hh_mod_cont$se[3], hh_mod_cont$ci.lb[3], hh_mod_cont$ci.ub[3], hh_mod_cont$zval[3], hh_mod_cont$pval[3],
  "Other",       hh_mod_cont$b[4], hh_mod_cont$se[4], hh_mod_cont$ci.lb[4], hh_mod_cont$ci.ub[4], hh_mod_cont$zval[4], hh_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

hh_table_continent <- hh_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

hh_table_continent <- add_header_lines(hh_table_continent, 
                                       values = c("Results of subgroup analysis for continent.", "Table 5"))
hh_table_continent <- theme_booktabs(hh_table_continent)

hh_table_continent <- italic(hh_table_continent, italic = TRUE, part = "header")

hh_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = hh_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_personality_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
hh_data_center <- hh_data %>% 
  mutate(alpha_hh_mean = scale(alpha_hh, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
hh_alpha <- rma(yi, vi, 
                random = list(~ 1 | es_id, # level 2
                              ~ 1 | study_id), # level 3
                data = hh_data_center, 
                digits = 3,
                mods = ~ 
                  alpha_hh_mean + alpha_ad_mean)

hh_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
hh_alpha$k
hh_alpha$b[1]
hh_alpha$ci.lb[1]
hh_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
hh_data_rem <- hh_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
hh_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = hh_data_rem, sm = "ZCOR",
                       method.tau = "REML")

hh_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
hh_data_rem <- escalc(measure = "ZCOR", 
                      ri = r, 
                      ni = sample_size, 
                      data = hh_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
hh_rem <- rma(yi, vi, 
              data = hh_data_rem, 
              slab = hh_data_rem$short_ref) 
hh_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(hh_rem) 
```

*** 
<br>

### Forest Plot

```{r}
hh_rem_forest <- viz_forest(hh_rem, 
                            summary_label = "Summary effect", 
                            study_labels = hh_data_rem$short_ref,
                            method = "REML",
                            xlab = "Correlation Coefficient", 
                            variant = "rain",
                            annotate_CI = TRUE, 
                            table_headers = "Correlation [95% CI]")

hh_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
hh_egger <- regtest(hh_rem)
hh_egger
```

*** 

<br>

### *p*-uniform

```{r}
hh_puniform <- puniform(ri = hh_data_rem$r, 
                        ni = hh_data_rem$N, 
                        alpha = .05,
                        side = "left", 
                        method = "P", 
                        plot = TRUE)

hh_puniform
```

Estimate: *r* = `r round(hh_puniform$est, 3)` 95% CI [`r round(hh_puniform$ci.lb, 3)`, `r round(hh_puniform$ci.ub, 3)`]
*k* = `r hh_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
hh_puniform_star <- puni_star(ri = hh_data_rem$r, 
                              ni = hh_data_rem$N, 
                              alpha = .05,
                              side = "left", 
                              method = "ML")
hh_puniform_star
```
Estimate: *r* = `r round(hh_puniform_star$est, 3)` 95% CI [`r round(hh_puniform_star$ci.lb, 3)`, `r round(hh_puniform_star$ci.ub, 3)`]

*k* = `r hh_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
hh_p_curve <- pcurve(hh_rem_meta, 
                     effect.estimation = TRUE, 
                     N = hh_data_rem$sample_size, 
                     dmin = 0, 
                     dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
hh_p_curve_est = hh_p_curve$dEstimate/sqrt(hh_p_curve$dEstimate^2 + 4)

hh_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
hh_petpeese <- PETPEESE.est(hh_data_rem$yi, hh_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

hh_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
hh_rem_sens <- leave1out(hh_rem, digits = 2)
round(min(hh_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(hh_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
hh_inf <- influence(hh_rem)

plot(hh_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
hh_baujat <- baujat(hh_rem, symbol = "slab")
hh_baujat
```

*** 

# 7. Machiavelism

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
mach_data <- escalc(measure = "ZCOR", 
                    ri = r_mach, 
                    ni = sample_size, 
                    data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
mach_mlm <- rma.mv(yi, 
                   vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   tdist = T, # Knapp-Hartung adjustment for confidence intervals
                   data = mach_data,
                   method = "REML")

summary(mach_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
mach_r <- predict(mach_mlm, digits = 3, transf = transf.ztor)

mach_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
mach_mlm_variance <- mlm.variance.distribution(x = mach_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
mach_mlm_level1 <- round(mach_mlm_variance[1, 1], 2)
mach_mlm_level1

mach_mlm_level2 <- round(mach_mlm_variance[2, 1], 2)
mach_mlm_level2

mach_mlm_level3 <- round(mach_mlm_variance[3, 1], 2)
mach_mlm_level3

mach_mlm_I2 <- sum(mach_mlm_level2, mach_mlm_level3)
mach_mlm_I2
```

`r mach_mlm_level1`% of the overall variance can be attributed to level 1, `r mach_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r mach_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r mach_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
mach_mlm.l2.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = mach_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(mach_mlm.l2.removed)

anova(mach_mlm, mach_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
mach_mlm.l3.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = mach_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(mach_mlm.l3.removed)

mach_mlm.l3.removed_anova <- anova(mach_mlm, mach_mlm.l3.removed)

mach_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot
```{r}
mach_data_year <- mach_data %>% 
  arrange(year)

mach_mlm_forest <- viz_forest(mach_mlm, 
                              summary_label = "Summary effect", 
                              study_labels = mach_data_year$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")

mach_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_mach.svg', width = 10, height = 11) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
mach_mlm_forest_mf <- forest(mach_mlm, 
                             slab = mach_data$short_ref,
                             addcred=F)

mach_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-1.2, 17.5, "Author(s) and Year",  pos=4)
text(1.6, 17.5, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
mach_mlm_funnel <- viz_funnel(x = mach_mlm, 
                              contours = TRUE,
                              trim_and_fill = F, 
                              egger = TRUE)

mach_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
mach_mod_age <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = mach_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ age_mean)
mach_mod_age
```

<br>

*F*(1, `r mach_mod_age$dfs`) = `r round(mach_mod_age$QM, 3)` *p* = `r round(mach_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(mach_data$vi)
size <- size / max(size)

mach_bubble_age <- ggplot(mach_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

mach_bubble_age
```




*** 
<br>

#### Sex

```{r}
mach_mod_sex <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = mach_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ perc_female)
mach_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(mach_data$vi)
size <- size / max(size)

mach_bubble_sex <- ggplot(mach_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

mach_bubble_sex
```

***
<br>

#### Study Quality

```{r}
mach_mod_quality <- rma.mv(yi, 
                           vi, 
                           random = list(~ 1 | es_id, # level 2
                                         ~ 1 | study_id), # level 3
                           data = mach_data,
                           method = "REML",
                           tdist = TRUE, 
                           mods = ~ mod_study_quality)
mach_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(mach_data$vi)
size <- size / max(size)

mach_bubble_quality <- ggplot(mach_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

mach_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
mach_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", mach_mod_age$k, mach_mod_age$b[2], mach_mod_age$se[2],  mach_mod_age$QM, mach_mod_age$QMp,
  "% Female", mach_mod_sex$k, mach_mod_sex$b[2], mach_mod_sex$se[2],  mach_mod_sex$QM, mach_mod_sex$QMp,
  "Study Quality", mach_mod_quality$k, mach_mod_quality$b[2], mach_mod_quality$se[2],  mach_mod_quality$QM, mach_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

mach_table_regression <- mach_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

mach_table_regression <- add_header_lines(mach_table_regression, 
                                          values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

mach_table_regression <- theme_booktabs(mach_table_regression)
mach_table_regression <- italic(mach_table_regression, italic = TRUE, part = "header")

mach_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
mach_data_mod1 <- mach_data %>%
  drop_na(mod_ad_inventory)

mach_mod_ad <- rma.mv(yi,
                      vi,
                      random = list(~ 1 | es_id, # level 2
                                    ~ 1 | study_id), # level 3
                      data = mach_data_mod1,
                      method = "REML",
                      tdist = TRUE,
                      mods = ~ mod_ad_inventory)

mach_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
mach_forest_ad <- viz_forest(x = mach_mod_ad,
                             study_labels =  mach_data_mod1$short_ref,
                             method = "REML",
                             summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                             xlab = "Correlation",
                             variant = "rain",
                             text_size = 2, 
                             annotate_CI = T)

mach_forest_ad
```

##### Table 

```{r}
mach_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      mach_mod_ad$b[1], mach_mod_ad$se[1], mach_mod_ad$ci.lb[1], mach_mod_ad$ci.ub[1], mach_mod_ad$zval[1], mach_mod_ad$pval[1], 
  "Self-Constructed",   mach_mod_ad$b[2], mach_mod_ad$se[2], mach_mod_ad$ci.lb[2], mach_mod_ad$ci.ub[2], mach_mod_ad$zval[2], mach_mod_ad$pval[2], 
  "Validated",       mach_mod_ad$b[3], mach_mod_ad$se[3], mach_mod_ad$ci.lb[3], mach_mod_ad$ci.ub[3], mach_mod_ad$zval[3], mach_mod_ad$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

mach_table_ad <- mach_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

mach_table_ad <- add_header_lines(mach_table_ad, 
                                  values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
mach_table_ad <- theme_booktabs(mach_table_ad)

mach_table_ad <- italic(mach_table_ad, italic = TRUE, part = "header")

mach_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# mach_data_mod2 <- mach_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = mach_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  mach_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Dark Inventory

```{r}
table(mach_data$mod_dark_inventory)
```


```{r}
# Dropping NAs
mach_data_mod3 <- mach_data %>%
  filter(mod_dark_inventory != "NA")

# calculating subgroup analyis
mach_mod_dark <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = mach_data_mod3,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ mod_dark_inventory)

mach_mod_dark
```

<br>

##### Subgroup Forest Plot

```{r}
mach_forest_dark <- viz_forest(x = mach_mod_dark,
                               study_labels =  mach_data_mod3$short_ref,
                               method = "REML",
                               summary_label = c("Individual Facets of Dark Triad", "Individual Facets of Dark Triad: Short Versions", "Dark Triad"), 
                               xlab = "Correlation",
                               variant = "rain",
                               text_size = 2, 
                               annotate_CI = T)

mach_forest_dark
```

##### Table

```{r}
mach_table_dark <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Individual Facets of Dark Triad ",      mach_mod_dark$b[1], mach_mod_dark$se[1], mach_mod_dark$ci.lb[1], mach_mod_dark$ci.ub[1], mach_mod_dark$zval[1], mach_mod_dark$pval[1], 
  "Individual Facets of Dark Triad: Short Version",   mach_mod_dark$b[2], mach_mod_dark$se[2], mach_mod_dark$ci.lb[2], mach_mod_dark$ci.ub[2], mach_mod_dark$zval[2], mach_mod_dark$pval[2], 
  "Dark Triad",       mach_mod_dark$b[3], mach_mod_dark$se[3], mach_mod_dark$ci.lb[3], mach_mod_dark$ci.ub[3], mach_mod_dark$zval[3], mach_mod_dark$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

mach_table_dark <- mach_table_dark %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

mach_table_dark <- add_header_lines(mach_table_dark, 
                                    values = c("Results of subgroup analysis for dark inventory.", "Table 4"))
mach_table_dark <- theme_booktabs(mach_table_dark)

mach_table_dark <- italic(mach_table_dark, italic = TRUE, part = "header")

mach_table_dark
```

#### Continent

```{r}
# Dropping NAs
mach_data_mod4 <- mach_data %>%
  drop_na(continent)

mach_mod_cont <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = mach_data_mod4,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ continent)

mach_mod_cont
```

```{r}
mach_forest_continent <- viz_forest(x = mach_mod_cont,
                                    study_labels =  mach_data_mod4$short_ref,
                                    method = "REML",
                                    summary_label = c("Asia", "Europe", "North America", "Other"), 
                                    xlab = "Correlation",
                                    variant = "rain",
                                    text_size = 2, 
                                    annotate_CI = T)

mach_forest_continent
```

##### Table

```{r}
mach_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      mach_mod_cont$b[1], mach_mod_cont$se[1], mach_mod_cont$ci.lb[1], mach_mod_cont$ci.ub[1], mach_mod_cont$zval[1], mach_mod_cont$pval[1], 
  "Europe",   mach_mod_cont$b[2], mach_mod_cont$se[2], mach_mod_cont$ci.lb[2], mach_mod_cont$ci.ub[2], mach_mod_cont$zval[2], mach_mod_cont$pval[2], 
  "North America",       mach_mod_cont$b[3], mach_mod_cont$se[3], mach_mod_cont$ci.lb[3], mach_mod_cont$ci.ub[3], mach_mod_cont$zval[3], mach_mod_cont$pval[3],
  "Other",       mach_mod_cont$b[4], mach_mod_cont$se[4], mach_mod_cont$ci.lb[4], mach_mod_cont$ci.ub[4], mach_mod_cont$zval[4], mach_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

mach_table_continent <- mach_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

mach_table_continent <- add_header_lines(mach_table_continent, 
                                         values = c("Results of subgroup analysis for continent.", "Table 5"))
mach_table_continent <- theme_booktabs(mach_table_continent)

mach_table_continent <- italic(mach_table_continent, italic = TRUE, part = "header")

mach_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = mach_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_dark_inventory)

mod_multiple
```


*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
mach_data_center <- mach_data %>% 
  mutate(alpha_mach_mean = scale(alpha_mach, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
mach_alpha <- rma(yi, vi, 
                  random = list(~ 1 | es_id, # level 2
                                ~ 1 | study_id), # level 3
                  data = mach_data_center, 
                  digits = 3,
                  mods = ~ 
                    alpha_mach_mean + alpha_ad_mean)

mach_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
mach_alpha$k
mach_alpha$b[1]
mach_alpha$ci.lb[1]
mach_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
mach_data_rem <- mach_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
mach_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = mach_data_rem, sm = "ZCOR",
                         method.tau = "REML")

mach_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
mach_data_rem <- escalc(measure = "ZCOR", 
                        ri = r, 
                        ni = sample_size, 
                        data = mach_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
mach_rem <- rma(yi, vi, 
                data = mach_data_rem, 
                slab = mach_data_rem$short_ref) 
mach_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(mach_rem) 
```

*** 
<br>

### Forest Plot

```{r}
mach_rem_forest <- viz_forest(mach_rem, 
                              summary_label = "Summary effect", 
                              study_labels = mach_data_rem$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")

mach_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
mach_egger <- regtest(mach_rem)
mach_egger
```

*** 

<br>

### *p*-uniform

```{r}
mach_puniform <- puniform(ri = mach_data_rem$r, 
                          ni = mach_data_rem$N, 
                          alpha = .05,
                          side = "right", 
                          method = "P", 
                          plot = TRUE)

mach_puniform
```

Estimate: *r* = `r round(mach_puniform$est, 3)` 95% CI [`r round(mach_puniform$ci.lb, 3)`, `r round(mach_puniform$ci.ub, 3)`]
*k* = `r mach_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
mach_puniform_star <- puni_star(ri = mach_data_rem$r, 
                                ni = mach_data_rem$N, 
                                alpha = .05,
                                side = "right", 
                                method = "ML")
mach_puniform_star
```
Estimate: *r* = `r round(mach_puniform_star$est, 3)` 95% CI [`r round(mach_puniform_star$ci.lb, 3)`, `r round(mach_puniform_star$ci.ub, 3)`]

*k* = `r mach_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
mach_p_curve <- pcurve(mach_rem_meta, 
                       effect.estimation = TRUE, 
                       N = mach_data_rem$sample_size, 
                       dmin = 0, 
                       dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
mach_p_curve_est = mach_p_curve$dEstimate/sqrt(mach_p_curve$dEstimate^2 + 4)

mach_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
mach_petpeese <- PETPEESE.est(mach_data_rem$yi, mach_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

mach_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
mach_rem_sens <- leave1out(mach_rem, digits = 2)
round(min(mach_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(mach_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
mach_inf <- influence(mach_rem)

plot(mach_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
mach_baujat <- baujat(mach_rem, symbol = "slab")
mach_baujat
```

*** 

# 8. Narcicism

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
narc_data <- escalc(measure = "ZCOR", 
                    ri = r_narc, 
                    ni = sample_size, 
                    data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
narc_mlm <- rma.mv(yi, 
                   vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   tdist = T, # Knapp-Hartung adjustment for confidence intervals
                   data = narc_data,
                   method = "REML")

summary(narc_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
narc_r <- predict(narc_mlm, digits = 3, transf = transf.ztor)

narc_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
narc_mlm_variance <- mlm.variance.distribution(x = narc_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
narc_mlm_level1 <- round(narc_mlm_variance[1, 1], 2)
narc_mlm_level1

narc_mlm_level2 <- round(narc_mlm_variance[2, 1], 2)
narc_mlm_level2

narc_mlm_level3 <- round(narc_mlm_variance[3, 1], 2)
narc_mlm_level3

narc_mlm_I2 <- sum(narc_mlm_level2, narc_mlm_level3)
narc_mlm_I2
```

`r narc_mlm_level1`% of the overall variance can be attributed to level 1, `r narc_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r narc_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r narc_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
narc_mlm.l2.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = narc_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(narc_mlm.l2.removed)

anova(narc_mlm, narc_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
narc_mlm.l3.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = narc_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(narc_mlm.l3.removed)

narc_mlm.l3.removed_anova <- anova(narc_mlm, narc_mlm.l3.removed)

narc_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot
```{r}
narc_data_year <- narc_data %>% 
  arrange(year)

narc_mlm_forest <- viz_forest(narc_mlm, 
                              summary_label = "Summary effect", 
                              study_labels = narc_data_year$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")

narc_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_narc.svg', width = 8, height = 11) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
narc_mlm_forest_mf <- forest(narc_mlm, 
                             slab = narc_data$short_ref,
                             addcred=F)

narc_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-2, 17.5, "Author(s) and Year",  pos=4)
text(1.75, 17.5, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
narc_mlm_funnel <- viz_funnel(x = narc_mlm, 
                              contours = TRUE,
                              trim_and_fill = F, 
                              egger = TRUE)

narc_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
narc_mod_age <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = narc_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ age_mean)
narc_mod_age
```

<br>

*F*(1, `r narc_mod_age$dfs`) = `r round(narc_mod_age$QM, 3)` *p* = `r round(narc_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(narc_data$vi)
size <- size / max(size)

narc_bubble_age <- ggplot(narc_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

narc_bubble_age
```




*** 
<br>

#### Sex

```{r}
narc_mod_sex <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = narc_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ perc_female)
narc_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(narc_data$vi)
size <- size / max(size)

narc_bubble_sex <- ggplot(narc_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

narc_bubble_sex
```

***
<br>

#### Study Quality

```{r}
narc_mod_quality <- rma.mv(yi, 
                           vi, 
                           random = list(~ 1 | es_id, # level 2
                                         ~ 1 | study_id), # level 3
                           data = narc_data,
                           method = "REML",
                           tdist = TRUE, 
                           mods = ~ mod_study_quality)
narc_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(narc_data$vi)
size <- size / max(size)

narc_bubble_quality <- ggplot(narc_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

narc_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
narc_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", narc_mod_age$k, narc_mod_age$b[2], narc_mod_age$se[2],  narc_mod_age$QM, narc_mod_age$QMp,
  "% Female", narc_mod_sex$k, narc_mod_sex$b[2], narc_mod_sex$se[2],  narc_mod_sex$QM, narc_mod_sex$QMp,
  "Study Quality", narc_mod_quality$k, narc_mod_quality$b[2], narc_mod_quality$se[2],  narc_mod_quality$QM, narc_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

narc_table_regression <- narc_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

narc_table_regression <- add_header_lines(narc_table_regression, 
                                          values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

narc_table_regression <- theme_booktabs(narc_table_regression)
narc_table_regression <- italic(narc_table_regression, italic = TRUE, part = "header")

narc_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
narc_data_mod1 <- narc_data %>%
  drop_na(mod_ad_inventory)

narc_mod_ad <- rma.mv(yi,
                      vi,
                      random = list(~ 1 | es_id, # level 2
                                    ~ 1 | study_id), # level 3
                      data = narc_data_mod1,
                      method = "REML",
                      tdist = TRUE,
                      mods = ~ mod_ad_inventory)

narc_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
narc_forest_ad <- viz_forest(x = narc_mod_ad,
                             study_labels =  narc_data_mod1$short_ref,
                             method = "REML",
                             summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                             xlab = "Correlation",
                             variant = "rain",
                             text_size = 2, 
                             annotate_CI = T)

narc_forest_ad
```

##### Table 

```{r}
narc_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      narc_mod_ad$b[1], narc_mod_ad$se[1], narc_mod_ad$ci.lb[1], narc_mod_ad$ci.ub[1], narc_mod_ad$zval[1], narc_mod_ad$pval[1], 
  "Self-Constructed",   narc_mod_ad$b[2], narc_mod_ad$se[2], narc_mod_ad$ci.lb[2], narc_mod_ad$ci.ub[2], narc_mod_ad$zval[2], narc_mod_ad$pval[2], 
  "Validated",       narc_mod_ad$b[3], narc_mod_ad$se[3], narc_mod_ad$ci.lb[3], narc_mod_ad$ci.ub[3], narc_mod_ad$zval[3], narc_mod_ad$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

narc_table_ad <- narc_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

narc_table_ad <- add_header_lines(narc_table_ad, 
                                  values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
narc_table_ad <- theme_booktabs(narc_table_ad)

narc_table_ad <- italic(narc_table_ad, italic = TRUE, part = "header")

narc_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# narc_data_mod2 <- narc_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = narc_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  narc_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Dark Inventory

```{r}
table(narc_data$mod_dark_inventory)
```


```{r}
# Dropping NAs
narc_data_mod3 <- narc_data %>%
  filter(mod_dark_inventory != "NA")

# calculating subgroup analyis
narc_mod_dark <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = narc_data_mod3,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ mod_dark_inventory)

narc_mod_dark
```

<br>

##### Subgroup Forest Plot

```{r}
narc_forest_dark <- viz_forest(x = narc_mod_dark,
                               study_labels =  narc_data_mod3$short_ref,
                               method = "REML",
                               summary_label = c("Individual Facets of Dark Triad", "Individual Facets of Dark Triad: Short Versions", "Dark Triad"), 
                               xlab = "Correlation",
                               variant = "rain",
                               text_size = 2, 
                               annotate_CI = T)

narc_forest_dark
```

##### Table

```{r}
narc_table_dark <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Individual Facets of Dark Triad",      narc_mod_dark$b[1], narc_mod_dark$se[1], narc_mod_dark$ci.lb[1], narc_mod_dark$ci.ub[1], narc_mod_dark$zval[1], narc_mod_dark$pval[1], 
  "Individual Facets of Dark Triad: Short Versions",   narc_mod_dark$b[2], narc_mod_dark$se[2], narc_mod_dark$ci.lb[2], narc_mod_dark$ci.ub[2], narc_mod_dark$zval[2], narc_mod_dark$pval[2], 
  "Dark Triad",       narc_mod_dark$b[3], narc_mod_dark$se[3], narc_mod_dark$ci.lb[3], narc_mod_dark$ci.ub[3], narc_mod_dark$zval[3], narc_mod_dark$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

narc_table_dark <- narc_table_dark %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

narc_table_dark <- add_header_lines(narc_table_dark, 
                                    values = c("Results of subgroup analysis for dark inventory.", "Table 4"))
narc_table_dark <- theme_booktabs(narc_table_dark)

narc_table_dark <- italic(narc_table_dark, italic = TRUE, part = "header")

narc_table_dark
```

#### Continent

```{r}
# Dropping NAs
narc_data_mod4 <- narc_data %>%
  drop_na(continent)

narc_mod_cont <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = narc_data_mod4,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ continent)

narc_mod_cont
```

```{r}
narc_forest_continent <- viz_forest(x = narc_mod_cont,
                                    study_labels =  narc_data_mod4$short_ref,
                                    method = "REML",
                                    summary_label = c("Asia", "Europe", "North America", "Other"), 
                                    xlab = "Correlation",
                                    variant = "rain",
                                    text_size = 2, 
                                    annotate_CI = T)
```

##### Table

```{r}
narc_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      narc_mod_cont$b[1], narc_mod_cont$se[1], narc_mod_cont$ci.lb[1], narc_mod_cont$ci.ub[1], narc_mod_cont$zval[1], narc_mod_cont$pval[1], 
  "Europe",   narc_mod_cont$b[2], narc_mod_cont$se[2], narc_mod_cont$ci.lb[2], narc_mod_cont$ci.ub[2], narc_mod_cont$zval[2], narc_mod_cont$pval[2], 
  "North America",       narc_mod_cont$b[3], narc_mod_cont$se[3], narc_mod_cont$ci.lb[3], narc_mod_cont$ci.ub[3], narc_mod_cont$zval[3], narc_mod_cont$pval[3],
  "Other",       narc_mod_cont$b[4], narc_mod_cont$se[4], narc_mod_cont$ci.lb[4], narc_mod_cont$ci.ub[4], narc_mod_cont$zval[4], narc_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

narc_table_continent <- narc_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

narc_table_continent <- add_header_lines(narc_table_continent, 
                                         values = c("Results of subgroup analysis for continent.", "Table 5"))
narc_table_continent <- theme_booktabs(narc_table_continent)

narc_table_continent <- italic(narc_table_continent, italic = TRUE, part = "header")

narc_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = narc_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_dark_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
narc_data_center <- narc_data %>% 
  mutate(alpha_narc_mean = scale(alpha_narc, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
narc_alpha <- rma(yi, vi, 
                  random = list(~ 1 | es_id, # level 2
                                ~ 1 | study_id), # level 3
                  data = narc_data_center, 
                  digits = 3,
                  mods = ~ 
                    alpha_narc_mean + alpha_ad_mean)

narc_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
narc_alpha$k
narc_alpha$b[1]
narc_alpha$ci.lb[1]
narc_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
narc_data_rem <- narc_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
narc_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = narc_data_rem, sm = "ZCOR",
                         method.tau = "REML")

narc_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
narc_data_rem <- escalc(measure = "ZCOR", 
                        ri = r, 
                        ni = sample_size, 
                        data = narc_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
narc_rem <- rma(yi, vi, 
                data = narc_data_rem, 
                slab = narc_data_rem$short_ref) 
narc_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(narc_rem) 
```

*** 
<br>

### Forest Plot

```{r}
narc_rem_forest <- viz_forest(narc_rem, 
                              summary_label = "Summary effect", 
                              study_labels = narc_data_rem$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")
narc_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
narc_egger <- regtest(narc_rem)
narc_egger
```

*** 

<br>

### *p*-uniform

```{r}
narc_puniform <- puniform(ri = narc_data_rem$r, 
                          ni = narc_data_rem$N, 
                          alpha = .05,
                          side = "right", 
                          method = "P", 
                          plot = TRUE)

narc_puniform
```

Estimate: *r* = `r round(narc_puniform$est, 3)` 95% CI [`r round(narc_puniform$ci.lb, 3)`, `r round(narc_puniform$ci.ub, 3)`]
*k* = `r narc_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
narc_puniform_star <- puni_star(ri = narc_data_rem$r, 
                                ni = narc_data_rem$N, 
                                alpha = .05,
                                side = "right", 
                                method = "ML")
narc_puniform_star
```
Estimate: *r* = `r round(narc_puniform_star$est, 3)` 95% CI [`r round(narc_puniform_star$ci.lb, 3)`, `r round(narc_puniform_star$ci.ub, 3)`]

*k* = `r narc_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
narc_p_curve <- pcurve(narc_rem_meta, 
                       effect.estimation = TRUE, 
                       N = narc_data_rem$sample_size, 
                       dmin = 0, 
                       dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
narc_p_curve_est = narc_p_curve$dEstimate/sqrt(narc_p_curve$dEstimate^2 + 4)

narc_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
narc_petpeese <- PETPEESE.est(narc_data_rem$yi, narc_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

narc_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
narc_rem_sens <- leave1out(narc_rem, digits = 2)
round(min(narc_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(narc_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
narc_inf <- influence(narc_rem)

plot(narc_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
narc_baujat <- baujat(narc_rem, symbol = "slab")
narc_baujat
```

*** 

# 9. Psychopathy

## Multilevel Meta-Analysis

### Fitting the model

#### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
psycho_data <- escalc(measure = "ZCOR", 
                      ri = r_psycho, 
                      ni = sample_size, 
                      data = data) %>% 
  drop_na(yi) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
psycho_mlm <- rma.mv(yi, 
                     vi, 
                     random = list(~ 1 | es_id, # level 2
                                   ~ 1 | study_id), # level 3
                     tdist = T, # Knapp-Hartung adjustment for confidence intervals
                     data = psycho_data,
                     method = "REML")

summary(psycho_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
psycho_r <- predict(psycho_mlm, digits = 3, transf = transf.ztor)

psycho_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
psycho_mlm_variance <- mlm.variance.distribution(x = psycho_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
psycho_mlm_level1 <- round(psycho_mlm_variance[1, 1], 2)
psycho_mlm_level1

psycho_mlm_level2 <- round(psycho_mlm_variance[2, 1], 2)
psycho_mlm_level2

psycho_mlm_level3 <- round(psycho_mlm_variance[3, 1], 2)
psycho_mlm_level3

psycho_mlm_I2 <- sum(psycho_mlm_level2, psycho_mlm_level3)
psycho_mlm_I2
```

`r psycho_mlm_level1`% of the overall variance can be attributed to level 1, `r psycho_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r psycho_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r psycho_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
psycho_mlm.l2.removed <- rma.mv(yi, 
                                vi, 
                                random = list(~ 1 | es_id, # level 2
                                              ~ 1 | study_id), # level 3
                                tdist = T, # Knapp-Hartung adjustment for confidence intervals
                                data = psycho_data,
                                method = "REML",
                                sigma2 = c(0, NA))

summary(psycho_mlm.l2.removed)

anova(psycho_mlm, psycho_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
psycho_mlm.l3.removed <- rma.mv(yi, 
                                vi, 
                                random = list(~ 1 | es_id, # level 2
                                              ~ 1 | study_id), # level 3
                                tdist = T, # Knapp-Hartung adjustment for confidence intervals
                                data = psycho_data,
                                method = "REML",
                                sigma2 = c(0, NA))

summary(psycho_mlm.l3.removed)

psycho_mlm.l3.removed_anova <- anova(psycho_mlm, psycho_mlm.l3.removed)

psycho_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot
```{r}
psycho_data_year <- psycho_data %>% 
  arrange(year)

psycho_mlm_forest <- viz_forest(psycho_mlm, 
                                summary_label = "Summary effect", 
                                study_labels = psycho_data_year$short_ref,
                                method = "REML",
                                xlab = "Correlation Coefficient", 
                                variant = "rain",
                                annotate_CI = TRUE, 
                                table_headers = "Correlation [95% CI]")

psycho_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_psycho.svg', width = 8, height = 11) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
psycho_mlm_forest_mf <- forest(psycho_mlm, 
                               slab = psycho_data$short_ref,
                               addcred=F)

psycho_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-1.9, 25, "Author(s) and Year",  pos=4)
text(2.1, 25, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```

*** 
<br>

### Funnel Plot
```{r}
# Show Egger's regression line:
psycho_mlm_funnel <- viz_funnel(x = psycho_mlm, 
                                contours = TRUE,
                                trim_and_fill = F, 
                                egger = TRUE)

psycho_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
psycho_mod_age <- rma.mv(yi, 
                         vi, 
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = psycho_data,
                         method = "REML",
                         tdist = TRUE, 
                         mods = ~ age_mean)
psycho_mod_age
```

<br>

*F*(1, `r psycho_mod_age$dfs`) = `r round(psycho_mod_age$QM, 3)` *p* = `r round(psycho_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(psycho_data$vi)
size <- size / max(size)

psycho_bubble_age <- ggplot(psycho_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

psycho_bubble_age
```




*** 
<br>

#### Sex

```{r}
psycho_mod_sex <- rma.mv(yi, 
                         vi, 
                         random = list(~ 1 | es_id, # level 2
                                       ~ 1 | study_id), # level 3
                         data = psycho_data,
                         method = "REML",
                         tdist = TRUE, 
                         mods = ~ perc_female)
psycho_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(psycho_data$vi)
size <- size / max(size)

psycho_bubble_sex <- ggplot(psycho_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

psycho_bubble_sex
```

***
<br>

#### Study Quality

```{r}
psycho_mod_quality <- rma.mv(yi, 
                             vi, 
                             random = list(~ 1 | es_id, # level 2
                                           ~ 1 | study_id), # level 3
                             data = psycho_data,
                             method = "REML",
                             tdist = TRUE, 
                             mods = ~ mod_study_quality)
psycho_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(psycho_data$vi)
size <- size / max(size)

psycho_bubble_quality <- ggplot(psycho_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

psycho_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
psycho_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", psycho_mod_age$k, psycho_mod_age$b[2], psycho_mod_age$se[2],  psycho_mod_age$QM, psycho_mod_age$QMp,
  "% Female", psycho_mod_sex$k, psycho_mod_sex$b[2], psycho_mod_sex$se[2],  psycho_mod_sex$QM, psycho_mod_sex$QMp,
  "Study Quality", psycho_mod_quality$k, psycho_mod_quality$b[2], psycho_mod_quality$se[2],  psycho_mod_quality$QM, psycho_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

psycho_table_regression <- psycho_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

psycho_table_regression <- add_header_lines(psycho_table_regression, 
                                            values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

psycho_table_regression <- theme_booktabs(psycho_table_regression)
psycho_table_regression <- italic(psycho_table_regression, italic = TRUE, part = "header")

psycho_table_regression 
# 
# # # Export to word
# # doc2 <- read_docx()
# # doc2 <- body_add_flextable(doc2, value = Table2)
# # # print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
psycho_data_mod1 <- psycho_data %>%
  drop_na(mod_ad_inventory)

psycho_mod_ad <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = psycho_data_mod1,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ mod_ad_inventory)

psycho_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
psycho_forest_ad <- viz_forest(x = psycho_mod_ad,
                               study_labels =  psycho_data_mod1$short_ref,
                               method = "REML",
                               summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                               xlab = "Correlation",
                               variant = "rain",
                               text_size = 2, 
                               annotate_CI = T)

psycho_forest_ad
```

##### Table 

```{r}
psycho_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      psycho_mod_ad$b[1], psycho_mod_ad$se[1], psycho_mod_ad$ci.lb[1], psycho_mod_ad$ci.ub[1], psycho_mod_ad$zval[1], psycho_mod_ad$pval[1], 
  "Self-Constructed",   psycho_mod_ad$b[2], psycho_mod_ad$se[2], psycho_mod_ad$ci.lb[2], psycho_mod_ad$ci.ub[2], psycho_mod_ad$zval[2], psycho_mod_ad$pval[2], 
  "Validated",       psycho_mod_ad$b[3], psycho_mod_ad$se[3], psycho_mod_ad$ci.lb[3], psycho_mod_ad$ci.ub[3], psycho_mod_ad$zval[3], psycho_mod_ad$pval[3] 
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

psycho_table_ad <- psycho_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

psycho_table_ad <- add_header_lines(psycho_table_ad, 
                                    values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
psycho_table_ad <- theme_booktabs(psycho_table_ad)

psycho_table_ad <- italic(psycho_table_ad, italic = TRUE, part = "header")

psycho_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# psycho_data_mod2 <- psycho_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = psycho_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  psycho_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Dark Inventory

```{r}
table(psycho_data$mod_dark_inventory)
```


```{r}
# Dropping NAs
psycho_data_mod3 <- psycho_data %>%
  filter(mod_dark_inventory != "NA")

# calculating subgroup analyis
psycho_mod_dark <- rma.mv(yi,
                          vi,
                          random = list(~ 1 | es_id, # level 2
                                        ~ 1 | study_id), # level 3
                          data = psycho_data_mod3,
                          method = "REML",
                          tdist = TRUE,
                          mods = ~ mod_dark_inventory)

psycho_mod_dark
```

<br>

##### Subgroup Forest Plot

```{r}
psycho_forest_dark <- viz_forest(x = psycho_mod_dark,
                                 study_labels =  psycho_data_mod3$short_ref,
                                 method = "REML",
                                 summary_label = c("Individual Facets of Dark Triad", "Individual Facets of Dark Triad: Short Versions", "Dark Triad"), 
                                 xlab = "Correlation",
                                 variant = "rain",
                                 text_size = 2, 
                                 annotate_CI = T)

psycho_forest_dark
```

##### Table

```{r}
psycho_table_dark <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Individual Facets of Dark Triad",      psycho_mod_dark$b[1], psycho_mod_dark$se[1], psycho_mod_dark$ci.lb[1], psycho_mod_dark$ci.ub[1], psycho_mod_dark$zval[1], psycho_mod_dark$pval[1], 
  "Individual Facets of Dark Triad: Short Versions",   psycho_mod_dark$b[2], psycho_mod_dark$se[2], psycho_mod_dark$ci.lb[2], psycho_mod_dark$ci.ub[2], psycho_mod_dark$zval[2], psycho_mod_dark$pval[2], 
  "Dark Triad",       psycho_mod_dark$b[3], psycho_mod_dark$se[3], psycho_mod_dark$ci.lb[3], psycho_mod_dark$ci.ub[3], psycho_mod_dark$zval[3], psycho_mod_dark$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

psycho_table_dark <- psycho_table_dark %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

psycho_table_dark <- add_header_lines(psycho_table_dark, 
                                      values = c("Results of subgroup analysis for dark inventory.", "Table 4"))
psycho_table_dark <- theme_booktabs(psycho_table_dark)

psycho_table_dark <- italic(psycho_table_dark, italic = TRUE, part = "header")

psycho_table_dark
```

#### Continent

```{r}
# Dropping NAs
psycho_data_mod4 <- psycho_data %>%
  drop_na(continent)

psycho_mod_cont <- rma.mv(yi,
                          vi,
                          random = list(~ 1 | es_id, # level 2
                                        ~ 1 | study_id), # level 3
                          data = psycho_data_mod4,
                          method = "REML",
                          tdist = TRUE,
                          mods = ~ continent)

psycho_mod_cont
```

```{r}
psycho_forest_continent <- viz_forest(x = psycho_mod_cont,
                                      study_labels =  psycho_data_mod4$short_ref,
                                      method = "REML",
                                      summary_label = c("Asia", "Europe", "North America", "Other"), 
                                      xlab = "Correlation",
                                      variant = "rain",
                                      text_size = 2, 
                                      annotate_CI = T)
```

##### Table

```{r}
psycho_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      psycho_mod_cont$b[1], psycho_mod_cont$se[1], psycho_mod_cont$ci.lb[1], psycho_mod_cont$ci.ub[1], psycho_mod_cont$zval[1], psycho_mod_cont$pval[1], 
  "Europe",   psycho_mod_cont$b[2], psycho_mod_cont$se[2], psycho_mod_cont$ci.lb[2], psycho_mod_cont$ci.ub[2], psycho_mod_cont$zval[2], psycho_mod_cont$pval[2], 
  "North America",       psycho_mod_cont$b[3], psycho_mod_cont$se[3], psycho_mod_cont$ci.lb[3], psycho_mod_cont$ci.ub[3], psycho_mod_cont$zval[3], psycho_mod_cont$pval[3],
  "Other",       psycho_mod_cont$b[4], psycho_mod_cont$se[4], psycho_mod_cont$ci.lb[4], psycho_mod_cont$ci.ub[4], psycho_mod_cont$zval[4], psycho_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

psycho_table_continent <- psycho_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

psycho_table_continent <- add_header_lines(psycho_table_continent, 
                                           values = c("Results of subgroup analysis for continent.", "Table 5"))
psycho_table_continent <- theme_booktabs(psycho_table_continent)

psycho_table_continent <- italic(psycho_table_continent, italic = TRUE, part = "header")

psycho_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = psycho_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_dark_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

```{r}
psycho_data_center <- psycho_data %>% 
  mutate(alpha_psycho_mean = scale(alpha_psycho, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
psycho_alpha <- rma(yi, vi, 
                    random = list(~ 1 | es_id, # level 2
                                  ~ 1 | study_id), # level 3
                    data = psycho_data_center, 
                    digits = 3,
                    mods = ~ 
                      alpha_psycho_mean + alpha_ad_mean)

psycho_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
psycho_alpha$k
psycho_alpha$b[1]
psycho_alpha$ci.lb[1]
psycho_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Dependency

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
psycho_data_rem <- psycho_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Random-effects model

#### With ```meta```
```{r}
psycho_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = psycho_data_rem, sm = "ZCOR",
                           method.tau = "REML")

psycho_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
psycho_data_rem <- escalc(measure = "ZCOR", 
                          ri = r, 
                          ni = sample_size, 
                          data = psycho_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
psycho_rem <- rma(yi, vi, 
                  data = psycho_data_rem, 
                  slab = psycho_data_rem$short_ref) 
psycho_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(psycho_rem) 
```

*** 
<br>

### Forest Plot

```{r}
psycho_rem_forest <- viz_forest(psycho_rem, 
                                summary_label = "Summary effect", 
                                study_labels = psycho_data_rem$short_ref,
                                method = "REML",
                                xlab = "Correlation Coefficient", 
                                variant = "rain",
                                annotate_CI = TRUE, 
                                table_headers = "Correlation [95% CI]")
psycho_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
psycho_egger <- regtest(psycho_rem)
psycho_egger
```

*** 

<br>

### *p*-uniform

```{r}
psycho_puniform <- puniform(ri = psycho_data_rem$r, 
                            ni = psycho_data_rem$N, 
                            alpha = .05,
                            side = "right", 
                            method = "P", 
                            plot = TRUE)

psycho_puniform
```

Estimate: *r* = `r round(psycho_puniform$est, 3)` 95% CI [`r round(psycho_puniform$ci.lb, 3)`, `r round(psycho_puniform$ci.ub, 3)`]
*k* = `r psycho_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
psycho_puniform_star <- puni_star(ri = psycho_data_rem$r, 
                                  ni = psycho_data_rem$N, 
                                  alpha = .05,
                                  side = "right", 
                                  method = "ML")
psycho_puniform_star
```
Estimate: *r* = `r round(psycho_puniform_star$est, 3)` 95% CI [`r round(psycho_puniform_star$ci.lb, 3)`, `r round(psycho_puniform_star$ci.ub, 3)`]

*k* = `r psycho_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
psycho_p_curve <- pcurve(psycho_rem_meta, 
                         effect.estimation = TRUE, 
                         N = psycho_data_rem$sample_size, 
                         dmin = 0, 
                         dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
psycho_p_curve_est = psycho_p_curve$dEstimate/sqrt(psycho_p_curve$dEstimate^2 + 4)

psycho_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
psycho_petpeese <- PETPEESE.est(psycho_data_rem$yi, psycho_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

psycho_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
psycho_rem_sens <- leave1out(psycho_rem, digits = 2)
round(min(psycho_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(psycho_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
psycho_inf <- influence(psycho_rem)

plot(psycho_inf, layout = c(4, 2))
```

*** 
<br>

### Baujat Plot
```{r}
psycho_baujat <- baujat(psycho_rem, symbol = "slab")
psycho_baujat
```

*** 

# 10. Dark constructs and academic dishonesty

Dark constructs are created by including psychoticism, neuroticsim, machiavelism and a reverse coded honesty-humilty.

## Multilevel Meta-Analysis

### Transform *r* to *z* and calculate the corresponding sample variances.

```{r}
dark_data <- data %>% 
  mutate(r_dishonesty = r_hh * -1) %>% 
  gather(key = dark_traits, value = dark_scores, r_psycho, r_narc, r_mach, r_dishonesty) %>% 
  drop_na(dark_scores) %>% # Remove rows with missing values for the correlation of interest
  arrange(year) %>% # Arrange by publication year for visualization
  mutate(es_id = row_number()) # es_id needs to be a unique identifier for each effect size
```


```{r}
dark_data <- escalc(measure = "ZCOR", 
                    ri = dark_scores, 
                    ni = sample_size, 
                    data = dark_data) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
dark_data
```

<br>

#### Calculate multilevel-meta-analysis

```{r}
dark_mlm <- rma.mv(yi, 
                   vi, 
                   random = list(~ 1 | es_id, # level 2
                                 ~ 1 | study_id), # level 3
                   tdist = T, # Knapp-Hartung adjustment for confidence intervals
                   data = dark_data,
                   method = "REML")

summary(dark_mlm)
```

<br>

#### Transform *z* back to Pearson´s *r*

```{r}
dark_r <- predict(dark_mlm, digits = 3, transf = transf.ztor)

dark_r
```
These two lines display the transformion of Fisher's *z* back to Pearson's *r* ("pred"), and the 95% confidence interval for *r* ("ci.lb" and "ci.ub") for reporting the meta-analysis.

*** 
<br>

### Distribution of Total Variance 

```{r}
dark_mlm_variance <- mlm.variance.distribution(x = dark_mlm)
```

<br>

Pulling out the variance estimates at level 1, 2, 3 and Higgins I^2^, which is the sum of level 2 and 3.
```{r}
dark_mlm_level1 <- round(dark_mlm_variance[1, 1], 2)
dark_mlm_level1

dark_mlm_level2 <- round(dark_mlm_variance[2, 1], 2)
dark_mlm_level2

dark_mlm_level3 <- round(dark_mlm_variance[3, 1], 2)
dark_mlm_level3

dark_mlm_I2 <- sum(dark_mlm_level2, dark_mlm_level3)
dark_mlm_I2
```

`r dark_mlm_level1`% of the overall variance can be attributed to level 1, `r dark_mlm_level2`% to level 2—the within-cluster heterogeneity—and as much as `r dark_mlm_level3`% to level 3—the between-cluster heterogeneity. The total amount of heterogeneity not attributable to sampling error is Higgins I^2^ = `r dark_mlm_I2`%.

### Comparing the fit

It is important to know if the three-level model captures the variability in our data better than a two-level model would. 

We therefore compare the models after removing on of its levels.

<br>

#### Model without level 2
```{r}
dark_mlm.l2.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = dark_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(dark_mlm.l2.removed)

anova(dark_mlm, dark_mlm.l2.removed)
```

<br>

Three-level model has lower AIC and BIC than two-level model, indicating better fit.

<br>

#### Model without level 3
```{r}
dark_mlm.l3.removed <- rma.mv(yi, 
                              vi, 
                              random = list(~ 1 | es_id, # level 2
                                            ~ 1 | study_id), # level 3
                              tdist = T, # Knapp-Hartung adjustment for confidence intervals
                              data = dark_data,
                              method = "REML",
                              sigma2 = c(0, NA))

summary(dark_mlm.l3.removed)

dark_mlm.l3.removed_anova <- anova(dark_mlm, dark_mlm.l3.removed)

dark_mlm.l3.removed_anova
```
<br>

Three-level model has lower AIC and BIC than the two-level model, indicating better fit.

*** 
<br>

### Forest Plot
```{r}
dark_data_year <- dark_data %>% 
  arrange(year)

dark_mlm_forest <- viz_forest(dark_mlm, 
                              summary_label = "Summary effect", 
                              study_labels = dark_data_year$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")

dark_mlm_forest
```

### Forest Plot in metafor

```{r}
svg(file = 'forestplot_dark.svg', width = 8, height = 13) 
### decrease margins so the full space is used
#par(mar=c(4,4,1,2))

### set up forest plot
dark_mlm_forest_mf <- forest(dark_mlm, 
                             slab = dark_data$short_ref,
                             addcred=F)

dark_mlm_forest_mf

### add column headings to the plot
op <- par(cex= 1, font=2)
text(-2.4, 62, "Author(s) and Year",  pos=4)
text(2.5, 62, "Correlation [95% CI]", pos=2)
par(op)

dev.off() 
```
*** 
<br>

### Funnel Plot
```{r}
# Show a trim-and-fill analysis and Egger's regression line:
dark_mlm_funnel <- viz_funnel(x = dark_mlm, 
                              contours = TRUE,
                              trim_and_fill = F, 
                              egger = TRUE)

dark_mlm_funnel
```

*** 
<br>

## Moderator Analysis

### Meta-Regressions

<br>

#### Mean Age
```{r}
dark_mod_age <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = dark_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ age_mean)
dark_mod_age
```

<br>

*F*(1, `r dark_mod_age$dfs`) = `r round(dark_mod_age$QM, 3)` *p* = `r round(dark_mod_age$QMp, 3)`.

<br>

##### Bubble Plot: Mean Age

```{r}
size <- 1 / sqrt(dark_data$vi)
size <- size / max(size)

dark_bubble_age <- ggplot(dark_data, aes(age_mean, yi, size = size)) +
  geom_point(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se=T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Mean Age") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

dark_bubble_age
```




*** 
<br>

#### Sex

```{r}
dark_mod_sex <- rma.mv(yi, 
                       vi, 
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = dark_data,
                       method = "REML",
                       tdist = TRUE, 
                       mods = ~ perc_female)
dark_mod_sex
```

<br>

##### Bubble Plot: Sex
```{r}
size <- 1 / sqrt(dark_data$vi)
size <- size / max(size)

dark_bubble_sex <- ggplot(dark_data, aes(perc_female, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Percentage Female") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

dark_bubble_sex
```

***
<br>

#### Study Quality

```{r}
dark_mod_quality <- rma.mv(yi, 
                           vi, 
                           random = list(~ 1 | es_id, # level 2
                                         ~ 1 | study_id), # level 3
                           data = dark_data,
                           method = "REML",
                           tdist = TRUE, 
                           mods = ~ mod_study_quality)
dark_mod_quality
```

<br>

##### Bubble Plot: Study Quality
```{r}
size <- 1 / sqrt(dark_data$vi)
size <- size / max(size)

dark_bubble_quality <- ggplot(dark_data, aes(mod_study_quality, yi, size = size)) +
  geom_jitter(alpha = 0.2, shape = 19) +
  geom_smooth(method = lm, color = "grey", se = T, size = 0.5, alpha = .2) +  
  ylab(expression("Pearsons"~italic("r"))) +
  xlab("Study Quality") +
  theme_classic() +
  scale_size_continuous(guide = F, range = c(1, 10))

dark_bubble_quality
```

<br>

#### Results from meta-regressions

```{r}
dark_table_regression <- tribble(
  ~Moderator,        ~k,            ~B,              ~SE,                          ~ F,        ~p,
  "Mean Age", dark_mod_age$k, dark_mod_age$b[2], dark_mod_age$se[2],  dark_mod_age$QM, dark_mod_age$QMp,
  "% Female", dark_mod_sex$k, dark_mod_sex$b[2], dark_mod_sex$se[2],  dark_mod_sex$QM, dark_mod_sex$QMp,
  "Study Quality", dark_mod_quality$k, dark_mod_quality$b[2], dark_mod_quality$se[2],  dark_mod_quality$QM, dark_mod_quality$QMp,
)

# Change digits
colkeys = c( "B", "SE", "F")

dark_table_regression <- dark_table_regression %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

dark_table_regression <- add_header_lines(dark_table_regression, 
                                          values = c("Results of meta-regressions for age, sex, and study quality.", "Table 2"))

dark_table_regression <- theme_booktabs(dark_table_regression)
dark_table_regression <- italic(dark_table_regression, italic = TRUE, part = "header")

dark_table_regression 

# Export to word
#  doc2 <- read_docx()
#  doc2 <- body_add_flextable(doc2, value = Table2)
#  print(doc2, target = "tables/Table2.docx")
```

*** 
<br>

### Subgroup Analysis

<br>

#### Academic Dishonesty Inventory

```{r}
# Dropping NAs
dark_data_mod1 <- dark_data %>%
  drop_na(mod_ad_inventory)

dark_mod_ad <- rma.mv(yi,
                      vi,
                      random = list(~ 1 | es_id, # level 2
                                    ~ 1 | study_id), # level 3
                      data = dark_data_mod1,
                      method = "REML",
                      tdist = TRUE,
                      mods = ~ mod_ad_inventory)

dark_mod_ad
```

<br>

##### Subgroup Forest Plot

```{r}
dark_forest_ad <- viz_forest(x = dark_mod_ad,
                             study_labels =  dark_data_mod1$short_ref,
                             method = "REML",
                             summary_label = c("Behavioral", "Self-Constructed", "Validated"), 
                             xlab = "Correlation",
                             variant = "rain",
                             text_size = 2, 
                             annotate_CI = T)

dark_forest_ad
```

##### Table 

```{r}
dark_table_ad <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Behavioral",      dark_mod_ad$b[1], dark_mod_ad$se[1], dark_mod_ad$ci.lb[1], dark_mod_ad$ci.ub[1], dark_mod_ad$zval[1], dark_mod_ad$pval[1], 
  "Self-Constructed",   dark_mod_ad$b[2], dark_mod_ad$se[2], dark_mod_ad$ci.lb[2], dark_mod_ad$ci.ub[2], dark_mod_ad$zval[2], dark_mod_ad$pval[2], 
  "Validated",       dark_mod_ad$b[3], dark_mod_ad$se[3], dark_mod_ad$ci.lb[3], dark_mod_ad$ci.ub[3], dark_mod_ad$zval[3], dark_mod_ad$pval[3] 
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

dark_table_ad <- dark_table_ad %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

dark_table_ad <- add_header_lines(dark_table_ad, 
                                  values = c("Results of subgroup analysis for academic dishonesty inventory.", "Table 3"))
dark_table_ad <- theme_booktabs(dark_table_ad)

dark_table_ad <- italic(dark_table_ad, italic = TRUE, part = "header")

dark_table_ad
```

*** 
<br>

#### Academic Dishonesty Time Period

```{r}
# # Dropping NAs
# dark_data_mod2 <- dark_data %>%
#   drop_na(mod_ad_period)
# 
# mod_ad_period <- rma.mv(yi,
#                         vi,
#                         random = list(~ 1 | es_id, # level 2
#                                       ~ 1 | study_id), # level 3
#                         data = dark_data_mod2,
#                         method = "REML",
#                         tdist = TRUE,
#                         mods = ~ mod_ad_period)
# 
# mod_ad_period
```

<br>

##### Subgroup Forest Plot

```{r}
# viz_forest(x = mod_ad_period,
#            study_labels =  dark_data_mod2$short_ref,
#            method = "REML",
#            summary_label = c("A", "B", "C", "D"), 
#            xlab = "Correlation",
#            variant = "rain",
#            text_size = 2, 
#            annotate_CI = T)
```

*** 
<br>

#### Dark Inventory

```{r}
table(dark_data$mod_dark_inventory)
```


```{r}
# Dropping NAs
dark_data_mod3 <- dark_data %>%
  filter(mod_dark_inventory != "NA")

# calculating subgroup analyis
dark_mod_dark <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = dark_data_mod3,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ mod_dark_inventory)

dark_mod_dark
```

<br>

##### Subgroup Forest Plot

```{r}
dark_forest_dark <- viz_forest(x = dark_mod_dark,
                               study_labels =  dark_data_mod3$short_ref,
                               method = "REML",
                               summary_label = c("Individual Facets of Dark Triad
", "Individual Facets of Dark Triad: Short Versions", "Dark Triad"), 
xlab = "Correlation",
variant = "rain",
text_size = 2, 
annotate_CI = T)
dark_forest_dark
```

##### Table

```{r}
dark_table_dark <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Individual Facets of Dark Triad",      dark_mod_dark$b[1], dark_mod_dark$se[1], dark_mod_dark$ci.lb[1], dark_mod_dark$ci.ub[1], dark_mod_dark$zval[1], dark_mod_dark$pval[1], 
  "Individual Facets of Dark Triad: Short Versions",   dark_mod_dark$b[2], dark_mod_dark$se[2], dark_mod_dark$ci.lb[2], dark_mod_dark$ci.ub[2], dark_mod_dark$zval[2], dark_mod_dark$pval[2], 
  "Dark Triad",       dark_mod_dark$b[3], dark_mod_dark$se[3], dark_mod_dark$ci.lb[3], dark_mod_dark$ci.ub[3], dark_mod_dark$zval[3], dark_mod_dark$pval[3]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

dark_table_dark <- dark_table_dark %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

dark_table_dark <- add_header_lines(dark_table_dark, 
                                    values = c("Results of subgroup analysis for dark inventory.", "Table 4"))
dark_table_dark <- theme_booktabs(dark_table_dark)

dark_table_dark <- italic(dark_table_dark, italic = TRUE, part = "header")

dark_table_dark
```

#### Continent

```{r}
# Dropping NAs
dark_data_mod4 <- dark_data %>%
  drop_na(continent)

dark_mod_cont <- rma.mv(yi,
                        vi,
                        random = list(~ 1 | es_id, # level 2
                                      ~ 1 | study_id), # level 3
                        data = dark_data_mod4,
                        method = "REML",
                        tdist = TRUE,
                        mods = ~ continent)

dark_mod_cont
```

```{r}
dark_forest_continent <- viz_forest(x = dark_mod_cont,
                                    study_labels =  dark_data_mod4$short_ref,
                                    method = "REML",
                                    summary_label = c("Asia", "Europe", "North America", "Other"), 
                                    xlab = "Correlation",
                                    variant = "rain",
                                    text_size = 2, 
                                    annotate_CI = T)
```

##### Table

```{r}
dark_table_continent <- tribble(
  ~Subgroup,   ~b    ,        ~SE,                 ~"95% CI Lower",         ~"95% CI Upper",       ~t,                     ~p,
  "Asia ",      dark_mod_cont$b[1], dark_mod_cont$se[1], dark_mod_cont$ci.lb[1], dark_mod_cont$ci.ub[1], dark_mod_cont$zval[1], dark_mod_cont$pval[1], 
  "Europe",   dark_mod_cont$b[2], dark_mod_cont$se[2], dark_mod_cont$ci.lb[2], dark_mod_cont$ci.ub[2], dark_mod_cont$zval[2], dark_mod_cont$pval[2], 
  "North America",       dark_mod_cont$b[3], dark_mod_cont$se[3], dark_mod_cont$ci.lb[3], dark_mod_cont$ci.ub[3], dark_mod_cont$zval[3], dark_mod_cont$pval[3],
  "Other",       dark_mod_cont$b[4], dark_mod_cont$se[4], dark_mod_cont$ci.lb[4], dark_mod_cont$ci.ub[4], dark_mod_cont$zval[4], dark_mod_cont$pval[4]
)

colkeys = c( "b", "95% CI Lower", "95% CI Upper", "SE", "t")

dark_table_continent <- dark_table_continent %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 2, na_str = "NA", big.mark = "") %>% 
  autofit()

dark_table_continent <- add_header_lines(dark_table_continent, 
                                         values = c("Results of subgroup analysis for continent.", "Table 5"))
dark_table_continent <- theme_booktabs(dark_table_continent)

dark_table_continent <- italic(dark_table_continent, italic = TRUE, part = "header")

dark_table_continent
```

*** 
<br>

### Multiple Meta-Regression

```{r}
mod_multiple <- rma.mv(yi,
                       vi,
                       random = list(~ 1 | es_id, # level 2
                                     ~ 1 | study_id), # level 3
                       data = dark_data,
                       method = "REML",
                       tdist = TRUE,
                       mods = ~ age_mean + 
                         mod_study_quality + 
                         perc_female +
                         mod_ad_inventory + 
                         mod_dark_inventory)

mod_multiple
```

*** 
<br>

## Artifact Correction

To correct for measurement error, we need to mean center the reliabilities first:

mutate(mod_ad_inventory = ifelse(ad_inventory %in% group_1, "1", # overwriting moderator variable with new groups
ifelse(ad_inventory %in% group_2, "2", "3")))

```{r}
dark_data <- dark_data %>% 
  mutate(alpha_dark = ifelse(dark_traits == "r_mach", alpha_mach, 
                             ifelse(dark_traits == "r_narc", alpha_narc, 
                                    ifelse(dark_traits == "r_psych", alpha_psych, 
                                           ifelse(dark_traits == "r_dishonesty", alpha_hh, NA)))))
```

```{r}
dark_data_center <- dark_data %>% 
  mutate(alpha_dark_mean = scale(alpha_dark, scale = F), 
         alpha_ad_mean = scale(alpha_ad, scale = F))
```

<br>

Now we can include the mean centered reliabilities in a meta-regression, the intercept is now the effect size estimate corrected for unreliability:

```{r}
dark_alpha <- rma(yi, vi, 
                  random = list(~ 1 | es_id, # level 2
                                ~ 1 | study_id), # level 3
                  data = dark_data_center, 
                  digits = 3,
                  mods = ~ 
                    alpha_dark_mean + alpha_ad_mean)

dark_alpha
```

<br>

The estimate corrected for measurement error:

```{r}
dark_alpha$k
dark_alpha$b[1]
dark_alpha$ci.lb[1]
dark_alpha$ci.ub[1]
```

*** 
<br>

## Two-Level Meta-Analysis

### Average Dependent Effect sizes

Several additional analyes can only be used with non-dependent effect sizes. Nondependency can be accomplished by averaging all effect sizes for each study.

```{r}
dark_data_rem <- dark_data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(r = sum(yi*sample_size)/sum(sample_size),   # Fisher´s z-transformed values are weighted by sample size
         vir = sum(vi*sample_size)/sum(sample_size), # sample variances are weighted by sample size
         N = mean(sample_size),                      # sample size is averaged
         gender = mean(perc_female)) %>%             # gender is averaged
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

<br>

### Calculate random-effects model

#### With ```meta```
```{r}
dark_rem_meta <- metacor(cor = r, n = sample_size, studlab = short_ref, data = dark_data_rem, sm = "ZCOR",
                         method.tau = "REML")

dark_rem_meta
```

#### With ```metafor```

##### Fishers *z* transformation
```{r}
dark_data_rem <- escalc(measure = "ZCOR", 
                        ri = r, 
                        ni = sample_size, 
                        data = dark_data_rem) %>% 
  drop_na(yi) # Remove rows with missing values for the correlation of interest
```

```{r}
dark_rem <- rma(yi, vi, 
                data = dark_data_rem, 
                slab = dark_data_rem$short_ref) 
dark_rem
```

The "estimate" provides the estimated model coefficient (i.e., the summary effect size) with standard error("se"). The z-value is the corresponding test statistic, "pval" is the corresponding p-value, "ci.lb" the the lower bound of the confidence interval and "ci.ub" the upper bound of the confidence interval.

<br>

##### Calculate confidence interval for the amount of heterogeneity (I^2^).

```{r}
confint(dark_rem) 
```

*** 
<br>

### Forest Plot

```{r}
dark_rem_forest <- viz_forest(dark_rem, 
                              summary_label = "Summary effect", 
                              study_labels = dark_data_rem$short_ref,
                              method = "REML",
                              xlab = "Correlation Coefficient", 
                              variant = "rain",
                              annotate_CI = TRUE, 
                              table_headers = "Correlation [95% CI]")
dark_rem_forest
```

*** 
<br>

## Publication bias

### Egger´s regression test

```{r}
dark_egger <- regtest(dark_rem)
dark_egger
```

*** 

<br>

### *p*-uniform

```{r}
dark_puniform <- puniform(ri = dark_data_rem$r, 
                          ni = dark_data_rem$N, 
                          alpha = .05,
                          side = "right", 
                          method = "P", 
                          plot = TRUE)

dark_puniform
```

Estimate: *r* = `r round(dark_puniform$est, 3)` 95% CI [`r round(dark_puniform$ci.lb, 3)`, `r round(dark_puniform$ci.ub, 3)`]
*k* = `r dark_puniform$ksig`

<br> 

### *p*-uniform* 

```{r}
dark_puniform_star <- puni_star(ri = dark_data_rem$r, 
                                ni = dark_data_rem$N, 
                                alpha = .05,
                                side = "right", 
                                method = "ML")
dark_puniform_star
```
Estimate: *r* = `r round(dark_puniform_star$est, 3)` 95% CI [`r round(dark_puniform_star$ci.lb, 3)`, `r round(dark_puniform_star$ci.ub, 3)`]

*k* = `r dark_puniform_star$k`

*** 
<br>

###  *p*-curve

```{r error=TRUE}
dark_p_curve <- pcurve(dark_rem_meta, 
                       effect.estimation = TRUE, 
                       N = dark_data_rem$sample_size, 
                       dmin = 0, 
                       dmax = 1)
```

<br>

We need to transform the Cohens *d* back to *r*:
```{r}
dark_p_curve_est = dark_p_curve$dEstimate/sqrt(dark_p_curve$dEstimate^2 + 4)

dark_p_curve_est
```

For a description [see](https://dmetar.protectlab.org/reference/pcurve.html)

*** 
<br>

### PET-PEESE 

```{r}
dark_petpeese <- PETPEESE.est(dark_data_rem$yi, dark_data_rem$vi, PP.test = "one-sided", runRMA=T, long=F)

dark_petpeese
```

*** 
<br>

## Sensitivity Analysis

```{r}
dark_rem_sens <- leave1out(dark_rem, digits = 2)
round(min(dark_rem_sens$estimate), 2) # smallest ES after leave one out analysis
round(max(dark_rem_sens$estimate), 2) # largest ES after leave one out analysis
```

*** 
<br>

### Influence analysis

```{r}
dark_inf <- influence(dark_rem)

plot(dark_inf, layout = c(4, 2))
```

*** 
<br>


### Baujat Plot
```{r}
dark_baujat <- baujat(dark_rem, symbol = "slab")
dark_baujat
```

*** 

# Benjamini Hochberg Correction

```{r}
sig_p <- c(consci_mod_age$pval[2],
           psycho_mod_quality$pval[2],
           dark_mod_quality$pval[2],
           mach_mod_ad$pval[2],
           narc_mod_ad$pval[2],
           psycho_mod_ad$pval[2],
           psycho_mod_ad$pval[3],
           dark_mod_ad$pval[2],
           dark_mod_ad$pval[3],
           dark_mod_dark$pval[3],
           consci_mod_cont$pval[4]
)

p.adjust(sig_p, method = "hochberg")
```

<br>

***

# Tables

To avoid any errors due to transferring values from R to tables/the manuscript, all tables are created with R and ```flextable```.


## Table 1: Study Overview

```{r}
data_table_1 <- data %>% 
  group_by(study_id) %>%                             # to average all studies per study_id 
  mutate(
    r_open = sum(r_open*sample_size)/sum(sample_size),
    r_consci = sum(r_consci*sample_size)/sum(sample_size),
    r_extra = sum(r_extra*sample_size)/sum(sample_size),
    r_agree = sum(r_agree*sample_size)/sum(sample_size),
    r_neuro = sum(r_neuro*sample_size)/sum(sample_size),   
    r_hh = sum(r_hh*sample_size)/sum(sample_size),
    r_narc = sum(r_narc*sample_size)/sum(sample_size),
    r_mach = sum(r_mach*sample_size)/sum(sample_size),
    r_psycho = sum(r_psycho*sample_size)/sum(sample_size),
    N = mean(sample_size),                      
    perc_female = mean(perc_female),
    personality_inventory = paste(personality_inventory, collapse=", "),
    ad_inventory = paste(ad_inventory, collapse=", "),
    dark_inventory = paste(dark_inventory, collapse=", ")
  ) %>%    
  distinct(study_id,                                   # only 1 effect size per study is kept
           .keep_all = TRUE)
```

```{r}
table1 <- data_table_1 %>% 
  select("Study ID" = study_id,
         "Authors, Year" = short_ref, 
         "Sample Country" = sample_country, 
         "Mean Age" = age_mean, 
         "% Female"= perc_female, 
         "AD Inventory" = ad_inventory, 
         "Personality Inventory" = personality_inventory, 
         "Dark Triad Inventory" = dark_inventory,
         "Sample Size" = sample_size, 
         "O" = r_open, 
         "C" = r_consci,
         "E" = r_extra,
         "A" = r_agree,
         "N" = r_neuro,
         "H" = r_hh,
         "NAR" = r_narc,
         "MAC" = r_mach,
         "PSY" = r_psycho,
         "Study Quality" = mod_study_quality) 

# Change digits
colkeys = c("Study ID","Mean Age", "% Female", "Sample Size", "Study Quality")

table1 <- table1 %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 0, na_str = "NA", big.mark = "") %>% 
  autofit() %>% 
  add_header_lines(values = c("Study information (author, year, country, mean age, percentage of female gender, inventories, sample size, effect size, and study quality).", "Table 1")) %>%
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table1

# Export to word
doc1 <- read_docx()
doc1 <- body_add_flextable(doc1, value = table1)
print(doc1, target = "tables/table1.docx")
```

## Table 2: Results

Meta-analysis of the relationship between the Big Five personality traits and ad

First, a vector for each meta-analysis is created.
```{r}
personality_vector <- c("open", "consci", "extra", "agree", "neuro", "hh", "mach", "narc", "psycho", "dark")
```

Now, a tibble and strings for the corresponding variables are created:
```{r}
output <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty", "Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)

output$k <- paste0(personality_vector, "_mlm$k")
output$N <- paste0("sum(", personality_vector,"_data$sample_size)")
output$r = paste0(personality_vector, "_r$pred")
output$r.lb = paste0(personality_vector, "_r$ci.lb")
output$r.ub = paste0(personality_vector, "_r$ci.ub")

#puniform*
output$puni = paste0(personality_vector, "_puniform_star$est")
output$puni.lb  = paste0(personality_vector, "_puniform_star$ci.lb")
output$puni.ub  = paste0(personality_vector, "_puniform_star$ci.ub")

# Heterogeneity
Q = paste0(personality_vector, "_mlm$QM")
p = paste0(personality_vector, "_mlm$QMp")
I = paste0(personality_vector, "_mlm_I2")
```

I attach the character strings and express them by using ```eval(parse(text= "string"))```:

```{r}
table2 <- output %>% 
  mutate(k = sapply(k, function(x) eval(parse(text=x)))) %>% 
  mutate(N = sapply(N, function(x) eval(parse(text=x)))) %>% 
  mutate(r = sapply(r, function(x) eval(parse(text=x)))) %>% 
  mutate(r.lb = sapply(r.lb, function(x) eval(parse(text=x)))) %>%
  mutate(r.ub = sapply(r.ub, function(x) eval(parse(text=x)))) %>% 
  mutate(puni = sapply(puni, function(x) eval(parse(text=x)))) %>%
  mutate(puni.lb = sapply(puni.lb, function(x) eval(parse(text=x)))) %>% 
  mutate(puni.ub = sapply(puni.ub, function(x) eval(parse(text=x)))) %>%
  mutate(Q = sapply(Q, function(x) eval(parse(text=x)))) %>% 
  mutate(p = sapply(p, function(x) eval(parse(text=x)))) %>%
  mutate(I = sapply(I, function(x) eval(parse(text=x))))
table2 
```

```{r}
# Change digits
colkeys = c("k", "N")

table2 <- table2 %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 0, na_str = "NA", big.mark = "") %>% 
  autofit()

table2 <- add_header_lines(table2, 
                           values = c("Results from meta-analyses of the relationship between the Big Five personality traits and ad.", "Table 2"))
table2 <- theme_booktabs(table2)

table2 <- italic(table2, italic = TRUE, part = "header")

table2

# Export to word
doc2 <- read_docx()
doc2 <- body_add_flextable(doc2, value = table2)
print(doc2, target = "tables/table2.docx")
```

## Table 3: Effect Sizes 

```{r}
table3 <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty", "Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)

# MLM
table3$k = paste0(personality_vector, "_mlm$k")
table3$r = paste0(personality_vector, "_r$pred")
table3$r.lb = paste0(personality_vector, "_r$ci.lb")
table3$r.ub = paste0(personality_vector, "_r$ci.ub")

#puniform
table3$puni.k = paste0(personality_vector, "_puniform$ksig")
table3$puni = paste0(personality_vector, "_puniform$est")
table3$puni.lb  = paste0(personality_vector, "_puniform$ci.lb")
table3$puni.ub  = paste0(personality_vector, "_puniform$ci.ub")

#puniform*
table3$puni_star.k = paste0(personality_vector, "_puniform_star$ksig")
table3$puni_star = paste0(personality_vector, "_puniform_star$est")
table3$puni_star.lb  = paste0(personality_vector, "_puniform_star$ci.lb")
table3$puni_star.ub  = paste0(personality_vector, "_puniform_star$ci.ub")

#pcurve
table3$pcurve = paste0(personality_vector, "_p_curve_est")

#petpeese
table3$petpeese = paste0(personality_vector, "_petpeese$estimate[11]")
table3$petpeese.lb = paste0(personality_vector, "_petpeese$conf.low[11]")
table3$petpeese.ub = paste0(personality_vector, "_petpeese$conf.high[11]")

# artifact correction
table3$corrected.k = paste0(personality_vector, "_alpha$k")
table3$corrected = paste0(personality_vector, "_alpha$b[1]")
table3$corrected.lb = paste0(personality_vector, "_alpha$ci.lb[1]")
table3$corrected.ub = paste0(personality_vector, "_alpha$ci.ub[1]")

table3
```

```{r}
table3 <- table3 %>% 
  # MLM
  mutate(k = sapply(k, function(x) eval(parse(text=x)))) %>% 
  mutate(r = sapply(r, function(x) eval(parse(text=x)))) %>% 
  mutate(r.lb = sapply(r.lb, function(x) eval(parse(text=x)))) %>% 
  mutate(r.ub = sapply(r.ub, function(x) eval(parse(text=x)))) %>% 
  
  # puniform
  mutate(puni.k = sapply(puni.k, function(x) eval(parse(text=x)))) %>% 
  mutate(puni = sapply(puni, function(x) eval(parse(text=x)))) %>% 
  mutate(puni.lb = sapply(puni.lb, function(x) eval(parse(text=x)))) %>% 
  mutate(puni.ub = sapply(puni.ub, function(x) eval(parse(text=x)))) %>% 
  
  # puniform*
  mutate(puni_star.k = sapply(puni_star.k, function(x) eval(parse(text=x)))) %>% 
  mutate(puni_star = sapply(puni_star, function(x) eval(parse(text=x)))) %>% 
  mutate(puni_star.lb = sapply(puni_star.lb, function(x) eval(parse(text=x)))) %>% 
  mutate(puni_star.ub = sapply(puni_star.ub, function(x) eval(parse(text=x))))  %>% 
  
  # pcurve
  mutate(pcurve = sapply(pcurve, function(x) eval(parse(text=x)))) %>% 
  
  # petpeese    
  mutate(petpeese = sapply(petpeese, function(x) eval(parse(text=x)))) %>% 
  mutate(petpeese.lb = sapply(petpeese.lb, function(x) eval(parse(text=x)))) %>% 
  mutate(petpeese.ub = sapply(petpeese.ub, function(x) eval(parse(text=x)))) %>%
  
  # artifact correction
  mutate(corrected.k = sapply(corrected.k, function(x) eval(parse(text=x)))) %>% 
  mutate(corrected = sapply(corrected, function(x) eval(parse(text=x)))) %>% 
  mutate(corrected.lb = sapply(corrected.lb, function(x) eval(parse(text=x)))) %>% 
  mutate(corrected.ub = sapply(corrected.ub, function(x) eval(parse(text=x))))

table3 
```

```{r}
# Change digits
colkeys = c("k")

table3 <- table3 %>% 
  flextable() %>% 
  colformat_num(col_keys = colkeys, digits = 0, na_str = "NA", big.mark = "") %>% 
  autofit()

table3 <- add_header_lines(table3, 
                           values = c("Results from meta-analyses of the relationship between the Big Five personality traits and ad.", "Table 3"))
table3 <- theme_booktabs(table3)

table3 <- italic(table3, italic = TRUE, part = "header")

table3

# Export to word
doc3 <- read_docx()
doc3 <- body_add_flextable(doc3, value = table3)
print(doc3, target = "tables/table3.docx")
```

## Table 4: Publication Bias

```{r}
table4 <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty", "Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)

table4$k = paste0(personality_vector, "_puniform_star$k")

#puniform*
table4$puni_star.l = paste0(personality_vector, "_puniform_star$L.pb")
table4$puni_star.p = paste0(personality_vector, "_puniform_star$pval.pb")

#Egger
table4$egger.z = paste0(personality_vector, "_egger$zval")
table4$egger.p = paste0(personality_vector, "_egger$pval")

table4 <- table4 %>% 
  mutate(k = sapply(k, function(x) eval(parse(text=x)))) %>% 
  # puniform test for publicaiton bias
  mutate(puni_star.l = sapply(puni_star.l, function(x) eval(parse(text=x)))) %>% 
  mutate(puni_star.p = sapply(puni_star.p, function(x) eval(parse(text=x)))) %>% 
  # Eggers Test 
  mutate(egger.z = sapply(egger.z, function(x) eval(parse(text=x)))) %>% 
  mutate(egger.p = sapply(egger.p, function(x) eval(parse(text=x)))) 

table4
```

```{r}
table4 <- table4 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Results from tests for publication bias.", 
                              "Table 4")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table4

# Export to word
doc4 <- read_docx()
doc4 <- body_add_flextable(doc4, value = table4)
print(doc4, target = "tables/table4.docx")
```

## Table 5: Meta-Regressions

Creating dataframe with strings for variables of interest:

```{r}
table5 <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty", "Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)

# age
age.k = paste0(personality_vector, "_mod_age$k")
age.est = paste0(personality_vector, "_mod_age$b[2]")
age.se = paste0(personality_vector, "_mod_age$se[2]")
age.f = paste0(personality_vector, "_mod_age$QM")
age.p = paste0(personality_vector, "_mod_age$QMp")

#sex
sex.k = paste0(personality_vector, "_mod_sex$k")
sex.est = paste0(personality_vector, "_mod_sex$b[2]")
sex.se = paste0(personality_vector, "_mod_sex$se[2]")
sex.f = paste0(personality_vector, "_mod_sex$QM")
sex.p = paste0(personality_vector, "_mod_sex$QMp")

quality.k = paste0(personality_vector, "_mod_quality$k")
quality.est = paste0(personality_vector, "_mod_quality$b[2]")
quality.se = paste0(personality_vector, "_mod_quality$se[2]")
quality.f = paste0(personality_vector, "_mod_quality$QM")
quality.p = paste0(personality_vector, "_mod_quality$QMp")
```

Evaluating the strings:
```{r}
table5 <- table5 %>% 
  # age
  mutate(age.k = sapply(age.k, function(x) eval(parse(text=x)))) %>% 
  mutate(age.est = sapply(age.est, function(x) eval(parse(text=x)))) %>% 
  mutate(age.se = sapply(age.se, function(x) eval(parse(text=x)))) %>% 
  mutate(age.f = sapply(age.f, function(x) eval(parse(text=x)))) %>%
  mutate(age.p = sapply(age.p, function(x) eval(parse(text=x)))) %>% 
  
  # sex
  mutate(sex.k = sapply(sex.k, function(x) eval(parse(text=x)))) %>% 
  mutate(sex.est = sapply(sex.est, function(x) eval(parse(text=x)))) %>% 
  mutate(sex.se = sapply(sex.se, function(x) eval(parse(text=x)))) %>% 
  mutate(sex.f = sapply(sex.f, function(x) eval(parse(text=x)))) %>%
  mutate(sex.p = sapply(sex.p, function(x) eval(parse(text=x)))) %>% 
  
  # study quality
  mutate(quality.k = sapply(quality.k, function(x) eval(parse(text=x)))) %>% 
  mutate(quality.est = sapply(quality.est, function(x) eval(parse(text=x)))) %>% 
  mutate(quality.se = sapply(quality.se, function(x) eval(parse(text=x)))) %>% 
  mutate(quality.f = sapply(quality.f, function(x) eval(parse(text=x)))) %>%
  mutate(quality.p = sapply(quality.p, function(x) eval(parse(text=x))))

table5
```

Creating table for export to Microsoft Word:
```{r}
table5 <- table5 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Results from tests for meta-regressions.", 
                              "Table 5")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table5

# Export to word
doc5 <- read_docx()
doc5 <- body_add_flextable(doc5, value = table5)
print(doc5, target = "tables/table5.docx")
```



## Table 6-9: Subgroup Analyses

### Table 6: Academic Dishonesty Inventory

```{r}
table6 <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty", "Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)

# Behavioral
ad_behavioral_b = paste0(personality_vector, "_mod_ad$b[1]")
ad_behavioral_se = paste0(personality_vector, "_mod_ad$se[1]")
ad_behavioral_ci_lb = paste0(personality_vector, "_mod_ad$ci.lb[1]")
ad_behavioral_ci_ub = paste0(personality_vector, "_mod_ad$ci.ub[1]")
ad_behavioral_z = paste0(personality_vector, "_mod_ad$zval[1]")
ad_behavioral_p = paste0(personality_vector, "_mod_ad$pval[1]")

# Self-Constructed
ad_constructed_b = paste0(personality_vector, "_mod_ad$b[2]")
ad_constructed_se = paste0(personality_vector, "_mod_ad$se[2]")
ad_constructed_ci_lb = paste0(personality_vector, "_mod_ad$ci.lb[2]")
ad_constructed_ci_ub = paste0(personality_vector, "_mod_ad$ci.ub[2]")
ad_constructed_z = paste0(personality_vector, "_mod_ad$zval[2]")
ad_constructed_p = paste0(personality_vector, "_mod_ad$pval[2]")

# Validated
ad_validated_b = paste0(personality_vector, "_mod_ad$b[3]")
ad_validated_se = paste0(personality_vector, "_mod_ad$se[3]")
ad_validated_ci_lb = paste0(personality_vector, "_mod_ad$ci.lb[3]")
ad_validated_ci_ub = paste0(personality_vector, "_mod_ad$ci.ub[3]")
ad_validated_z = paste0(personality_vector, "_mod_ad$zval[3]")
ad_validated_p = paste0(personality_vector, "_mod_ad$pval[3]")

table6 <- table6 %>% 
  
  # behavioral
  mutate(ad_behavioral_b = sapply(ad_behavioral_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_behavioral_se = sapply(ad_behavioral_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_behavioral_ci_lb = sapply(ad_behavioral_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_behavioral_ci_ub = sapply(ad_behavioral_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_behavioral_z = sapply(ad_behavioral_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_behavioral_p = sapply(ad_behavioral_p, function(x) eval(parse(text=x)))) %>% 
  
  # constructed
  mutate(ad_constructed_b = sapply(ad_constructed_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_constructed_se = sapply(ad_constructed_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_constructed_ci_lb = sapply(ad_constructed_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_constructed_ci_ub = sapply(ad_constructed_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_constructed_z = sapply(ad_constructed_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_constructed_p = sapply(ad_constructed_p, function(x) eval(parse(text=x)))) %>% 
  
  # validated
  mutate(ad_validated_b = sapply(ad_validated_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_validated_se = sapply(ad_validated_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_validated_ci_lb = sapply(ad_validated_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_validated_ci_ub = sapply(ad_validated_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_validated_z = sapply(ad_validated_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_validated_p = sapply(ad_validated_p, function(x) eval(parse(text=x))))  

table6
```

Creating table for export to Microsoft Word:
```{r}
table6 <- table6 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Results from subgroup analyses for academic dishonesty inventory.", 
                              "Table 6")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table6

# Export to word
doc6 <- read_docx()
doc6 <- body_add_flextable(doc6, value = table6)
print(doc6, target = "tables/table6.docx")
```

### Table 7: Personality Inventory

_mod_pers

```{r}
personality_vector <- c("open", "consci", "extra", "agree", "neuro", "hh")

table7 <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty"),
)

# big_5
ad_big_5_b = paste0(personality_vector, "_mod_pers$b[1]")
ad_big_5_se = paste0(personality_vector, "_mod_pers$se[1]")
ad_big_5_ci_lb = paste0(personality_vector, "_mod_pers$ci.lb[1]")
ad_big_5_ci_ub = paste0(personality_vector, "_mod_pers$ci.ub[1]")
ad_big_5_z = paste0(personality_vector, "_mod_pers$zval[1]")
ad_big_5_p = paste0(personality_vector, "_mod_pers$pval[1]")

# big_5_short
ad_big_5_short_b = paste0(personality_vector, "_mod_pers$b[2]")
ad_big_5_short_se = paste0(personality_vector, "_mod_pers$se[2]")
ad_big_5_short_ci_lb = paste0(personality_vector, "_mod_pers$ci.lb[2]")
ad_big_5_short_ci_ub = paste0(personality_vector, "_mod_pers$ci.ub[2]")
ad_big_5_short_z = paste0(personality_vector, "_mod_pers$zval[2]")
ad_big_5_short_p = paste0(personality_vector, "_mod_pers$pval[2]")

# big_6
ad_big_6_b = paste0(personality_vector, "_mod_pers$b[3]")
ad_big_6_se = paste0(personality_vector, "_mod_pers$se[3]")
ad_big_6_ci_lb = paste0(personality_vector, "_mod_pers$ci.lb[3]")
ad_big_6_ci_ub = paste0(personality_vector, "_mod_pers$ci.ub[3]")
ad_big_6_z = paste0(personality_vector, "_mod_pers$zval[3]")
ad_big_6_p = paste0(personality_vector, "_mod_pers$pval[3]")

# other
ad_other_b = paste0(personality_vector, "_mod_pers$b[4]")
ad_other_se = paste0(personality_vector, "_mod_pers$se[4]")
ad_other_ci_lb = paste0(personality_vector, "_mod_pers$ci.lb[4]")
ad_other_ci_ub = paste0(personality_vector, "_mod_pers$ci.ub[4]")
ad_other_z = paste0(personality_vector, "_mod_pers$zval[4]")
ad_other_p = paste0(personality_vector, "_mod_pers$pval[4]")

table7 <- table7 %>% 
  
  # big_5
  mutate(ad_big_5_b = sapply(ad_big_5_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_se = sapply(ad_big_5_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_ci_lb = sapply(ad_big_5_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_ci_ub = sapply(ad_big_5_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_big_5_z = sapply(ad_big_5_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_p = sapply(ad_big_5_p, function(x) eval(parse(text=x)))) %>% 
  
  # big_5_short
  mutate(ad_big_5_short_b = sapply(ad_big_5_short_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_short_se = sapply(ad_big_5_short_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_short_ci_lb = sapply(ad_big_5_short_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_short_ci_ub = sapply(ad_big_5_short_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_big_5_short_z = sapply(ad_big_5_short_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_5_short_p = sapply(ad_big_5_short_p, function(x) eval(parse(text=x)))) %>% 
  
  # big_6
  mutate(ad_big_6_b = sapply(ad_big_6_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_6_se = sapply(ad_big_6_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_6_ci_lb = sapply(ad_big_6_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_6_ci_ub = sapply(ad_big_6_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_big_6_z = sapply(ad_big_6_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_big_6_p = sapply(ad_big_6_p, function(x) eval(parse(text=x))))  %>% 
  
  # other
  mutate(ad_other_b = sapply(ad_other_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_other_se = sapply(ad_other_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_other_ci_lb = sapply(ad_other_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_other_ci_ub = sapply(ad_other_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_other_z = sapply(ad_other_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_other_p = sapply(ad_other_p, function(x) eval(parse(text=x)))) 

table7
```

Creating table for export to Microsoft Word:
```{r}
table7 <- table7 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Results from subgroup analyses for personality inventory.", 
                              "Table 7")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table7

# Export to word
doc7 <- read_docx()
doc7 <- body_add_flextable(doc7, value = table7)
print(doc7, target = "tables/table7.docx")
```

### Table 8:Dark Inventory

```{r}
personality_vector <- c("mach", "narc", "psycho", "dark")

table8 <- tibble(
  "Trait" = c("Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)

# facet
ad_facet_b = paste0(personality_vector, "_mod_dark$b[1]")
ad_facet_se = paste0(personality_vector, "_mod_dark$se[1]")
ad_facet_ci_lb = paste0(personality_vector, "_mod_dark$ci.lb[1]")
ad_facet_ci_ub = paste0(personality_vector, "_mod_dark$ci.ub[1]")
ad_facet_z = paste0(personality_vector, "_mod_dark$zval[1]")
ad_facet_p = paste0(personality_vector, "_mod_dark$pval[1]")

# Self-short
ad_short_b = paste0(personality_vector, "_mod_dark$b[2]")
ad_short_se = paste0(personality_vector, "_mod_dark$se[2]")
ad_short_ci_lb = paste0(personality_vector, "_mod_dark$ci.lb[2]")
ad_short_ci_ub = paste0(personality_vector, "_mod_dark$ci.ub[2]")
ad_short_z = paste0(personality_vector, "_mod_dark$zval[2]")
ad_short_p = paste0(personality_vector, "_mod_dark$pval[2]")

# triad
ad_triad_b = paste0(personality_vector, "_mod_dark$b[3]")
ad_triad_se = paste0(personality_vector, "_mod_dark$se[3]")
ad_triad_ci_lb = paste0(personality_vector, "_mod_dark$ci.lb[3]")
ad_triad_ci_ub = paste0(personality_vector, "_mod_dark$ci.ub[3]")
ad_triad_z = paste0(personality_vector, "_mod_dark$zval[3]")
ad_triad_p = paste0(personality_vector, "_mod_dark$pval[3]")

table8 <- table8 %>% 
  
  # facet
  mutate(ad_facet_b = sapply(ad_facet_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_facet_se = sapply(ad_facet_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_facet_ci_lb = sapply(ad_facet_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_facet_ci_ub = sapply(ad_facet_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_facet_z = sapply(ad_facet_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_facet_p = sapply(ad_facet_p, function(x) eval(parse(text=x)))) %>% 
  
  # short
  mutate(ad_short_b = sapply(ad_short_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_short_se = sapply(ad_short_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_short_ci_lb = sapply(ad_short_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_short_ci_ub = sapply(ad_short_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_short_z = sapply(ad_short_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_short_p = sapply(ad_short_p, function(x) eval(parse(text=x)))) %>% 
  
  # triad
  mutate(ad_triad_b = sapply(ad_triad_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_triad_se = sapply(ad_triad_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_triad_ci_lb = sapply(ad_triad_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_triad_ci_ub = sapply(ad_triad_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_triad_z = sapply(ad_triad_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_triad_p = sapply(ad_triad_p, function(x) eval(parse(text=x))))  

table8
```

Creating table for export to Microsoft Word:
```{r}
table8 <- table8 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Results from  subgroup analyses for dark trait inventory.", 
                              "Table 8")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table8

# Export to word
doc8 <- read_docx()
doc8 <- body_add_flextable(doc8, value = table8)
print(doc8, target = "tables/table8.docx")
```

### Table 9: Continent

```{r}
personality_vector <- c("open", "consci", "extra", "agree", "neuro", "hh", "mach", "narc", "psycho", "dark")

table9 <- tibble(
  "Trait" = c("Openness", "Conscientousness", "Extraversion", "Agreeableness", "Neuroticism", "Honesty", "Machiavelism",  "Narcicsm",  "Psychopathy", "Dark Traits"),
)
# asia
ad_asia_b = paste0(personality_vector, "_mod_cont$b[1]")
ad_asia_se = paste0(personality_vector, "_mod_cont$se[1]")
ad_asia_ci_lb = paste0(personality_vector, "_mod_cont$ci.lb[1]")
ad_asia_ci_ub = paste0(personality_vector, "_mod_cont$ci.ub[1]")
ad_asia_z = paste0(personality_vector, "_mod_cont$zval[1]")
ad_asia_p = paste0(personality_vector, "_mod_cont$pval[1]")

# europe
ad_europe_b = paste0(personality_vector, "_mod_cont$b[2]")
ad_europe_se = paste0(personality_vector, "_mod_cont$se[2]")
ad_europe_ci_lb = paste0(personality_vector, "_mod_cont$ci.lb[2]")
ad_europe_ci_ub = paste0(personality_vector, "_mod_cont$ci.ub[2]")
ad_europe_z = paste0(personality_vector, "_mod_cont$zval[2]")
ad_europe_p = paste0(personality_vector, "_mod_cont$pval[2]")

# america
ad_america_b = paste0(personality_vector, "_mod_cont$b[3]")
ad_america_se = paste0(personality_vector, "_mod_cont$se[3]")
ad_america_ci_lb = paste0(personality_vector, "_mod_cont$ci.lb[3]")
ad_america_ci_ub = paste0(personality_vector, "_mod_cont$ci.ub[3]")
ad_america_z = paste0(personality_vector, "_mod_cont$zval[3]")
ad_america_p = paste0(personality_vector, "_mod_cont$pval[3]")

# rest
ad_rest_b = paste0(personality_vector, "_mod_cont$b[4]")
ad_rest_se = paste0(personality_vector, "_mod_cont$se[4]")
ad_rest_ci_lb = paste0(personality_vector, "_mod_cont$ci.lb[4]")
ad_rest_ci_ub = paste0(personality_vector, "_mod_cont$ci.ub[4]")
ad_rest_z = paste0(personality_vector, "_mod_cont$zval[4]")
ad_rest_p = paste0(personality_vector, "_mod_cont$pval[4]")

table9 <- table9 %>% 
  
  # asia
  mutate(ad_asia_b = sapply(ad_asia_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_asia_se = sapply(ad_asia_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_asia_ci_lb = sapply(ad_asia_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_asia_ci_ub = sapply(ad_asia_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_asia_z = sapply(ad_asia_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_asia_p = sapply(ad_asia_p, function(x) eval(parse(text=x)))) %>% 
  
  # europe
  mutate(ad_europe_b = sapply(ad_europe_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_europe_se = sapply(ad_europe_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_europe_ci_lb = sapply(ad_europe_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_europe_ci_ub = sapply(ad_europe_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_europe_z = sapply(ad_europe_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_europe_p = sapply(ad_europe_p, function(x) eval(parse(text=x)))) %>% 
  
  # america
  mutate(ad_america_b = sapply(ad_america_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_america_se = sapply(ad_america_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_america_ci_lb = sapply(ad_america_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_america_ci_ub = sapply(ad_america_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_america_z = sapply(ad_america_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_america_p = sapply(ad_america_p, function(x) eval(parse(text=x))))  %>% 
  
  # rest
  mutate(ad_rest_b = sapply(ad_rest_b, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_rest_se = sapply(ad_rest_se, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_rest_ci_lb = sapply(ad_rest_ci_lb, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_rest_ci_ub = sapply(ad_rest_ci_ub, function(x) eval(parse(text=x)))) %>%
  mutate(ad_rest_z = sapply(ad_rest_z, function(x) eval(parse(text=x)))) %>% 
  mutate(ad_rest_p = sapply(ad_rest_p, function(x) eval(parse(text=x)))) 

table9
```

Creating table for export to Microsoft Word:
```{r}
table9 <- table9 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Results from  subgroup analyses for continents.", 
                              "Table 9")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table9

# Export to word
doc9 <- read_docx()
doc9 <- body_add_flextable(doc9, value = table9)
print(doc9, target = "tables/table9.docx")
```

## Table 10: Descriptives

```{r}
options(digits = 2)
table10 <- tribble(
  ~Moderator, ~k,                       ~Min, ~Max, ~Mean, ~SD, ~"(2)", ~"(3)", ~"(4)", ~"(5)",
  "(1) Year",      sum(!is.na(data$year)), min(data$year), max(data$year), mean(data$year), sd(data$year), cor(data$year, data$sample_size, use = "complete.obs"), cor(data$year, data$perc_female, use = "complete.obs"), cor(data$year, data$age_mean, use = "complete.obs"), cor(data$year, data$mod_study_quality, use = "complete.obs"), 
  "(2) N",         sum(!is.na(data$sample_size)), min(data$sample_size), max(data$sample_size), mean(data$sample_size), sd(data$sample_size), "", cor(data$sample_size, data$perc_female, use = "complete.obs"), cor(data$sample_size, data$age_mean, use = "complete.obs"), cor(data$sample_size, data$mod_study_quality, use = "complete.obs"), 
  "(3) % Woman",   sum(!is.na(data$perc_female)), min(data$perc_female, na.rm = T), max(data$perc_female, na.rm = T), mean(data$perc_female, na.rm = T), sd(data$perc_female, na.rm = T), "", "", cor(data$perc_female, data$age_mean, use = "complete.obs"), cor(data$perc_female, data$mod_study_quality, use = "complete.obs"), 
  "(4) Age",       sum(!is.na(data$age_mean)), min(data$age_mean, na.rm = T), max(data$age_mean, na.rm = T), mean(data$age_mean, na.rm = T), sd(data$age_mean, na.rm = T), "","","", cor(data$age_mean, data$mod_study_quality, use = "complete.obs"), 
  "(5) Quality",   sum(!is.na(data$mod_study_quality)), min(data$mod_study_quality), max(data$mod_study_quality), mean(data$mod_study_quality), sd(data$mod_study_quality), "", "", "", ""
)
table10 <- table10 %>% 
  mutate_at(vars(c("(2)":"(5)")), funs(as.numeric))
```

```{r}
table10 <- table10 %>% 
  flextable() %>% 
  autofit() %>% 
  add_header_lines(values = c("Descriptive Statistics for Publication Year, Sample Size, Percentage of Women in the Sample, Mean Age, and Study Quality.", 
                              "Table 10")) %>% 
  theme_booktabs() %>% 
  italic(italic = TRUE, part = "header")

table10

# Export to word
doc10 <- read_docx()
doc10 <- body_add_flextable(doc10, value = table10)
print(doc10, target = "tables/table10.docx")
```

#### Correlogram

```{r}
data_cor <- data %>% 
  select(year, 
         "N" = sample_size, 
         "% Woman" =perc_female, 
         "Age" = age_mean, 
         "Quality" = mod_study_quality)

res <- cor(data_cor, use = "complete.obs")

corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```

#### Chart of correlation matrix

```{r}
chart.Correlation(data_cor, histogram=TRUE, pch=19)
```

# Figures

## Forest Plots
These functions create all metaviz plots used in the preprint in the folder "figures".

```{r}
# list of values to loop over
personality_vector <- c("open", "consci", "extra", "agree", "neuro", "hh", "mach", "narc", "psycho", "dark")

# Loop
for (i in personality_vector) {
  
  p_string =  paste0(i, "_mlm_forest")
  p <-  eval(parse(text = p_string))
  
  ggsave(p, file = paste0("figures/",i, "_mlm_forest", ".png"), width = 18, height = 20, units = "cm")
}
```


## Funnel Plots

```{r}
# list of values to loop over
personality_vector <- c("open", "consci", "extra", "agree", "neuro", "hh", "mach", "narc", "psycho", "dark")

# Loop
for (i in personality_vector) {
  
  p_string =  paste0(i, "_mlm_funnel")
  p <-  eval(parse(text = p_string))
  
  ggsave(p, file = paste0("figures/",i, "_mlm_funnel", ".png"), width = 16, height = 16, units = "cm")
}
```

